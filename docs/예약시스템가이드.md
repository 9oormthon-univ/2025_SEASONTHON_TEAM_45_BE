# 예약 시스템 가이드

CareFreePass의 예약 관리 시스템 사용법을 상세히 안내합니다.

## 🏥 예약 시스템 개요

병원 관리자가 환자의 예약을 생성, 수정, 삭제하고 환자 상태를 관리하는 시스템입니다.

### 예약 상태 관리
```
BOOKED (예약됨) → ARRIVED (도착함) → CALLED (호출됨) → COMPLETED (완료됨)
                                                    ↓
                                               CANCELLED (취소됨)
```

## 🔍 예약 가능 시간 조회

### 1. 의사별 예약 가능 시간 조회
```http
GET /api/v1/appointments/available-times/doctor?doctorName=김의사&date=2025-09-01
```

**응답 예시:**
```json
{
  "code": "APPOINTMENT_2008",
  "message": "의사별 예약 가능 시간 조회가 완료되었습니다.",
  "data": [
    "09:00:00",
    "09:30:00", 
    "10:00:00",
    "11:00:00",
    "14:00:00",
    "15:30:00"
  ]
}
```

### 2. 진료실별 예약 가능 시간 조회
```http
GET /api/v1/appointments/available-times/room?roomNumber=101호&date=2025-09-01
```

**응답 예시:**
```json
{
  "code": "APPOINTMENT_2009", 
  "message": "진료실별 예약 가능 시간 조회가 완료되었습니다.",
  "data": [
    "09:00:00",
    "10:30:00",
    "13:00:00", 
    "16:00:00"
  ]
}
```

### 3. 진료 시간 설정
- **기본 진료 시간**: 09:00 ~ 17:00
- **예약 간격**: 30분 단위
- **총 시간 슬롯**: 16개

## 📋 예약 생성

### 1. 시간 충돌 검사 시스템
예약 생성 시 3단계 검증을 거쳐 중복을 방지합니다:

1. **환자별 중복 검사**: 같은 날짜에 이미 예약이 있는지 확인
2. **의사별 시간 충돌 검사**: 같은 의사가 동일 시간에 중복 예약 방지  
3. **진료실별 시간 충돌 검사**: 같은 진료실이 동일 시간에 중복 사용 방지

**충돌 시 오류 메시지 예시:**
```json
{
  "code": "APPOINTMENT_4001",
  "message": "의사 '김의사'는 2025-09-01 10:30 시간에 이미 예약이 있습니다.",
  "data": null
}
```

### 2. API 요청
```http
POST /api/v1/appointments
Content-Type: application/json

{
  "memberId": 1,
  "hospitalName": "서울대병원",
  "department": "내과", 
  "doctorName": "김의사",
  "appointmentDate": "2025-08-30",
  "appointmentTime": "10:30:00",
  "roomNumber": "2번 진료실"
}
```

### 2. 요청 파라미터
| 필드 | 타입 | 필수 | 설명 |
|-----|------|------|------|
| memberId | Long | ✅ | 환자 회원 ID |
| hospitalName | String | ✅ | 병원명 |
| department | String | ✅ | 진료과 |
| doctorName | String | ❌ | 담당의사명 |
| appointmentDate | LocalDate | ✅ | 예약 날짜 (YYYY-MM-DD) |
| appointmentTime | LocalTime | ✅ | 예약 시간 (HH:mm:ss) |
| roomNumber | String | ❌ | 진료실 번호 |

### 3. 응답 예시
```json
{
  "status": "OK",
  "code": "APPOINTMENT_2001", 
  "message": "예약이 성공적으로 생성되었습니다.",
  "data": 15
}
```

### 4. 비즈니스 규칙
- 같은 날짜에 동일 환자의 중복 예약 불가
- 예약 생성 시 자동으로 예약 확인 알림 전송
- 초기 상태는 `BOOKED`로 설정

## 📝 예약 수정

### 1. API 요청
```http
PUT /api/v1/appointments/{appointmentId}
Content-Type: application/json

{
  "hospitalName": "서울대병원",
  "department": "외과",
  "doctorName": "이의사", 
  "appointmentDate": "2025-08-31",
  "appointmentTime": "14:00:00",
  "roomNumber": "3번 진료실"
}
```

### 2. 수정 제한사항
- `COMPLETED` 또는 `CANCELLED` 상태의 예약은 수정 불가
- 예약 ID가 존재하지 않으면 오류 발생

### 3. 응답 예시
```json
{
  "status": "OK",
  "code": "APPOINTMENT_2007",
  "message": "예약이 성공적으로 수정되었습니다.",
  "data": "SUCCESS"
}
```

## 📅 예약 조회

### 1. 오늘 전체 예약 조회
```http
GET /api/v1/appointments/today
```

### 2. 오늘 대기 환자 조회
```http
GET /api/v1/appointments/today/waiting
```

### 3. 응답 예시
```json
{
  "status": "OK",
  "code": "APPOINTMENT_2004",
  "message": "오늘 전체 예약 목록 조회가 완료되었습니다.",
  "data": [
    {
      "appointmentId": 15,
      "memberName": "김환자",
      "hospitalName": "서울대병원",
      "department": "내과",
      "doctorName": "김의사", 
      "appointmentDate": "2025-08-30",
      "appointmentTime": "10:30:00",
      "roomNumber": "2번 진료실",
      "status": "BOOKED",
      "statusDescription": "예약됨",
      "canCall": true
    }
  ]
}
```

### 4. 응답 필드 설명
| 필드 | 타입 | 설명 |
|-----|------|------|
| appointmentId | Long | 예약 ID |
| memberName | String | 환자명 |
| statusDescription | String | 상태 한글 설명 |
| canCall | Boolean | 호출 가능 여부 |

## 🏃‍♂️ 환자 체크인

### 1. API 요청
```http
PUT /api/v1/appointments/checkin
Content-Type: application/json

{
  "appointmentId": 15,
  "memberId": 1
}
```

### 2. 체크인 규칙
- `BOOKED` 상태에서만 체크인 가능
- 본인의 예약만 체크인 가능
- 체크인 후 상태가 `ARRIVED`로 변경

### 3. 응답 예시
```json
{
  "status": "OK", 
  "code": "APPOINTMENT_2002",
  "message": "체크인이 완료되었습니다.",
  "data": "SUCCESS"
}
```

## 📞 환자 호출

### 1. API 요청
```http
POST /api/v1/notifications/call
Content-Type: application/json

{
  "appointmentId": 15,
  "roomNumber": "2번 진료실"
}
```

### 2. 호출 프로세스
1. 예약 ID로 환자 정보 조회
2. FCM 토큰 확인
3. 푸시 알림 전송
4. 성공 시 상태를 `CALLED`로 변경
5. 알림 이력 저장

### 3. 호출 조건
- `COMPLETED` 또는 `CANCELLED` 상태가 아닌 경우
- 환자의 FCM 토큰이 등록되어 있는 경우

### 4. 알림 메시지 형식
```
제목: "진료 호출"
내용: "{환자명}님, {진료실}로 들어오세요."
```

## ❌ 예약 삭제

### 1. API 요청
```http
DELETE /api/v1/appointments/{appointmentId}
```

### 2. 응답 예시
```json
{
  "status": "OK",
  "code": "APPOINTMENT_2005", 
  "message": "예약이 성공적으로 삭제되었습니다.",
  "data": "SUCCESS"
}
```

## 🔄 상태 변경

### 1. API 요청
```http
PUT /api/v1/appointments/{appointmentId}/status/{status}
```

### 2. 사용 가능한 상태
- `BOOKED` - 예약됨
- `ARRIVED` - 도착함  
- `CALLED` - 호출됨
- `COMPLETED` - 완료됨
- `CANCELLED` - 취소됨

### 3. 요청 예시
```http
PUT /api/v1/appointments/15/status/COMPLETED
```

## 🖥️ 테스트 페이지 사용법

### 1. 테스트 페이지 접속
```
http://localhost:8080/test-fcm.html
```

### 2. 예약 생성 테스트
1. **회원가입**: 환자 정보 입력 후 회원가입
2. **예약 생성**: 
   - 회원 ID: 생성된 회원 ID 입력
   - 병원명: 서울대병원
   - 진료과: 내과
   - 의사명: 김의사
   - 예약 날짜: 오늘 날짜 (자동 설정)
   - 예약 시간: 10:30
   - 진료실: 2번 진료실
3. **예약 생성** 버튼 클릭

### 3. 예약 관리 테스트
1. **목록 새로고침**: 생성된 예약 확인
2. **예약 수정**: ✏️ 수정 버튼 클릭 → 모달에서 정보 수정
3. **예약 삭제**: 🗑️ 삭제 버튼 클릭
4. **환자 호출**: 📢 호출 버튼 클릭 (FCM 토큰 등록 필요)

### 4. 상태별 동작 테스트
```
예약 생성 → BOOKED (호출 가능)
체크인 → ARRIVED (호출 가능) 
호출 → CALLED (호출 가능)
완료 → COMPLETED (호출 불가)
```

## 🚨 에러 처리

### 일반적인 에러 코드
| 코드 | 메시지 | 해결방법 |
|-----|--------|----------|
| APPOINTMENT_4001 | 존재하지 않는 회원입니다 | 올바른 회원 ID 확인 |
| APPOINTMENT_4001 | 해당 날짜에 이미 예약이 있습니다 | 다른 날짜로 예약 생성 |
| APPOINTMENT_4003 | 존재하지 않는 예약입니다 | 올바른 예약 ID 확인 |
| APPOINTMENT_4005 | 완료되거나 취소된 예약은 수정할 수 없습니다 | 예약 상태 확인 후 수정 |

### 서버 에러 처리
- 모든 예외는 글로벌 예외 처리기에서 처리
- 클라이언트에 일관된 응답 형식 제공
- 에러 로그는 서버 콘솔에서 확인 가능

## 📊 데이터베이스 스키마

### Appointment 테이블
```sql
CREATE TABLE appointment (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    member_id BIGINT NOT NULL,
    hospital_name VARCHAR(100) NOT NULL,
    department VARCHAR(50) NOT NULL, 
    doctor_name VARCHAR(50),
    appointment_date DATE NOT NULL,
    appointment_time TIME NOT NULL,
    room_number VARCHAR(20),
    status ENUM('BOOKED', 'ARRIVED', 'CALLED', 'COMPLETED', 'CANCELLED') NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (member_id) REFERENCES member(id)
);
```

## 🔗 연동 시스템

### 알림 시스템과의 연동
- 예약 생성 시 → 예약 확인 알림 전송
- 환자 호출 시 → 호출 알림 전송  
- 알림 전송 결과를 NotificationHistory에 저장

### 회원 시스템과의 연동
- 예약 생성 시 회원 존재 여부 검증
- 체크인 시 본인 확인
- 예약 조회 시 회원 정보 포함

---

예약 시스템 사용 중 문제가 발생하면 [API 문서](./API_DOCUMENTATION.md)를 참조하거나 서버 로그를 확인해주세요.