# FCM 구현 단계별 가이드

## 1. 사전 준비 단계

### 1.1 Firebase 프로젝트 생성
1. **Firebase Console 접속**
   - https://console.firebase.google.com/ 에 접속
   - Google 계정으로 로그인

2. **새 프로젝트 생성**
   - "프로젝트 추가" 클릭
   - 프로젝트 이름 입력 (예: "hospital-booking-system")
   - Google Analytics 설정 (선택사항, 나중에 추가 가능)
   - 프로젝트 생성 완료

### 1.2 FCM 활성화
1. **Cloud Messaging 설정** 
   - Firebase 콘솔 좌측 메뉴에서 "Cloud Messaging" 선택
   - FCM이 자동으로 활성화됨

2. **서비스 계정 키 생성**
   - 프로젝트 설정 → 서비스 계정 탭
   - "새 비공개 키 생성" 클릭
   - JSON 파일 다운로드 (서버에서 사용할 인증 파일)

## 2. 플랫폼별 설정

### 2.1 Android 앱 설정
1. **앱 등록**
   - Firebase 콘솔에서 "앱 추가" → Android 아이콘 선택
   - 패키지 이름 입력 (예: com.hospital.booking)
   - 앱 닉네임 입력 (선택사항)

2. **google-services.json 다운로드**
   - 구성 파일 다운로드
   - 안드로이드 프로젝트의 `app/` 폴더에 배치

3. **Gradle 설정 준비**
   - 프로젝트 수준과 앱 수준 build.gradle 파일 수정 내용 확인
   - Firebase SDK 의존성 추가 준비

### 2.2 iOS 앱 설정 (필요한 경우)
1. **앱 등록**
   - Firebase 콘솔에서 "앱 추가" → iOS 아이콘 선택
   - Bundle ID 입력
   - 앱 닉네임 입력

2. **GoogleService-Info.plist 다운로드**
   - 구성 파일 다운로드
   - Xcode 프로젝트에 추가

3. **APNs 인증서 설정**
   - Apple Developer Console에서 APNs 인증서 생성
   - Firebase 콘솔에 업로드

## 3. 서버 환경 설정

### 3.1 서버 인증 설정
1. **Firebase Admin SDK 설치 준비**
   - Node.js: `npm install firebase-admin`
   - Python: `pip install firebase-admin`
   - Java: Maven/Gradle 의존성 추가

2. **서비스 계정 키 파일 배치**
   - 다운로드한 JSON 파일을 서버의 안전한 위치에 저장
   - 환경변수 또는 설정 파일로 경로 지정

### 3.2 데이터베이스 스키마 설계
```
users 테이블:
- id (PK)
- name
- phone
- fcm_token (FCM 토큰 저장)
- created_at
- updated_at

appointments 테이블:
- id (PK)
- user_id (FK)
- hospital_id
- department
- doctor_name
- appointment_date
- appointment_time
- status (예약/도착/호출/진료중/완료)
- created_at
```

## 4. 앱 개발 단계

### 4.1 FCM 토큰 관리
1. **토큰 생성 및 획득**
   - 앱 시작시 FCM 토큰 생성
   - 토큰 변경 감지 리스너 설정

2. **토큰 서버 전송**
   - 로그인 성공시 토큰을 서버로 전송
   - 토큰 갱신시 자동 업데이트

3. **토큰 만료 처리**
   - 토큰 갱신 감지
   - 자동 재등록 로직

### 4.2 푸시 알림 수신 처리
1. **포그라운드 알림**
   - 앱이 활성 상태일 때 알림 처리
   - 커스텀 알림 UI 표시

2. **백그라운드 알림**
   - 앱이 백그라운드/종료 상태일 때 처리
   - 시스템 알림으로 표시

3. **알림 클릭 처리**
   - 알림 클릭시 특정 화면으로 이동
   - 딥링크 처리

### 4.3 권한 요청
1. **알림 권한**
   - Android 13+ 에서 런타임 권한 요청
   - 권한 거부시 설정 화면 안내

2. **배터리 최적화 예외**
   - 안정적인 알림 수신을 위한 설정
   - 사용자 안내 UI 제공

## 5. 웹 관리자 페이지 개발

### 5.1 환자 목록 화면
1. **실시간 데이터 표시**
   - 환자 상태별 색상 구분
   - 자동 새로고침 기능

2. **호출 버튼 구현**
   - 환자별 개별 호출 버튼
   - 호출 상태 즉시 반영

### 5.2 API 엔드포인트 설계
```
POST /api/call-patient
- 환자 호출 요청
- FCM 푸시 전송

GET /api/patients/waiting
- 대기 중인 환자 목록 조회

PUT /api/patient/{id}/status
- 환자 상태 수동 변경
```

## 6. 서버 개발

### 6.1 FCM 서비스 모듈
1. **FCM 클라이언트 초기화**
   - 서비스 계정 키로 인증
   - Admin SDK 초기화

2. **푸시 전송 함수**
   - 단일 기기 전송
   - 메시지 포맷 정의
   - 전송 결과 처리

### 6.2 API 컨트롤러
1. **토큰 등록 API**
   - FCM 토큰 수신 및 저장
   - 중복 토큰 처리

2. **환자 호출 API**
   - 환자 정보 조회
   - FCM 푸시 전송
   - 상태 업데이트

## 7. 테스트 단계

### 7.1 개발 환경 테스트
1. **Firebase Console 테스트**
   - 콘솔에서 직접 테스트 메시지 발송
   - 토큰 유효성 확인

2. **API 테스트**
   - Postman 등으로 API 동작 확인
   - 토큰 등록/호출 플로우 테스트

### 7.2 통합 테스트
1. **앱-서버 연동**
   - 실제 앱에서 토큰 등록 테스트
   - 웹에서 호출시 앱 알림 수신 확인

2. **예외 상황 테스트**
   - 네트워크 끊김 상황
   - 앱 종료 상태에서 알림 수신
   - 잘못된 토큰 처리

## 8. 배포 및 운영 준비

### 8.1 보안 설정
1. **API 키 보안**
   - 서버 키는 서버에서만 사용
   - 클라이언트에서는 절대 노출 금지

2. **토큰 관리**
   - 토큰 암호화 저장
   - 만료된 토큰 정리 스케줄링

### 8.2 모니터링 준비
1. **전송 성공률 모니터링**
   - FCM 응답 코드 로깅
   - 실패 원인 분석

2. **성능 모니터링**
   - 응답 속도 측정
   - 서버 리소스 사용량 확인

## 9. 운영 중 고려사항

### 9.1 스케일링
1. **대용량 처리**
   - 배치 전송 API 활용
   - 큐 시스템 도입 고려

2. **부하 분산**
   - FCM 요청 제한 고려
   - 재시도 로직 구현

### 9.2 사용자 경험 개선
1. **알림 커스터마이징**
   - 진료과별 다른 알림음
   - 중요도별 진동 패턴

2. **접근성 고려**
   - 시각/청각 장애인 대응
   - 다국어 지원 준비

이 가이드를 따라 단계별로 구현하시면 안정적인 FCM 시스템을 구축할 수 있습니다.