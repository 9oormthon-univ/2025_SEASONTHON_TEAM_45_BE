name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
    
    - name: Cache Gradle dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
    
    - name: Make gradlew executable
      run: chmod +x ./gradlew
    
    - name: Run tests
      run: ./gradlew test -Dspring.profiles.active=test
    
    - name: Generate test report
      uses: dorny/test-reporter@v1
      if: success() || failure()
      with:
        name: Gradle Tests
        path: build/test-results/test/*.xml
        reporter: java-junit
        fail-on-error: true

  build-and-deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
    
    - name: Cache Gradle dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
    
    - name: Make gradlew executable
      run: chmod +x ./gradlew
    
    - name: Build JAR
      run: ./gradlew bootJar
    
    - name: Get current time
      uses: josStorer/get-current-time@v2
      id: current-time
      with:
        format: YYYY-MM-DD-HH-mm-ss
        utcOffset: "+09:00"
    
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 22
        timeout: 60s
        script: |
          # ì• í”Œë¦¬ì¼€ì´ì…˜ ë””ë ‰í† ë¦¬ ìƒì„±
          sudo mkdir -p /opt/carefreepass
          sudo chown $USER:$USER /opt/carefreepass
          
          # ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ (ìžˆë‹¤ë©´)
          sudo pkill -f 'carefreepass.*jar' || true
          
          # ìž ì‹œ ëŒ€ê¸°
          sleep 5
          
          # ë°±ì—… ë° ì •ë¦¬
          if [ -f /opt/carefreepass/carefreepass-server.jar ]; then
            mv /opt/carefreepass/carefreepass-server.jar /opt/carefreepass/carefreepass-server-backup-${{ steps.current-time.outputs.formattedTime }}.jar
          fi
          
          # ì˜¤ëž˜ëœ ë°±ì—… íŒŒì¼ ì‚­ì œ (ìµœê·¼ 5ê°œë§Œ ë³´ê´€)
          cd /opt/carefreepass
          ls -t carefreepass-server-backup-*.jar 2>/dev/null | tail -n +6 | xargs rm -f || true

    - name: Copy JAR to EC2
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 22
        source: "build/libs/*.jar"
        target: "/tmp/"
        strip_components: 2

    - name: Start Application
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 22
        timeout: 60s
        script: |
          # JAR íŒŒì¼ ì´ë™
          sudo mv /tmp/*.jar /opt/carefreepass/carefreepass-server.jar
          
          # í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ì´ ìžˆëŠ”ì§€ í™•ì¸
          if [ ! -f /opt/carefreepass/.env ]; then
            echo "Warning: .env file not found at /opt/carefreepass/.env"
            exit 1
          else
            echo "âœ… .env file found"
          fi
          
          # Java í”„ë¡œì„¸ìŠ¤ í™•ì¸
          if ! java -version 2>&1 | grep -q "21"; then
            echo "Java 21 not found, installing..."
            sudo apt update
            sudo apt install -y openjdk-21-jdk
          fi
          
          # JVM ì˜µì…˜ ë¡œë“œ ë° ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œìž‘ (t2.micro ìµœì í™”)
          cd /opt/carefreepass
          JVM_OPTS=$(cat jvm.conf 2>/dev/null || echo "-Xms256m -Xmx768m -XX:+UseG1GC")
          
          nohup java $JVM_OPTS -jar \
            -Dspring.profiles.active=datasource \
            -Dserver.port=8080 \
            carefreepass-server.jar > application.log 2>&1 &
          
          # í”„ë¡œì„¸ìŠ¤ ì‹œìž‘ í™•ì¸
          sleep 10
          
          if pgrep -f 'carefreepass.*jar' > /dev/null; then
            echo "âœ… Application started successfully"
            echo "Process ID: $(pgrep -f 'carefreepass.*jar')"
          else
            echo "âŒ Failed to start application"
            echo "--- Last 20 lines of log ---"
            tail -n 20 application.log || echo "No log file found"
            exit 1
          fi

    - name: Health Check
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 22
        timeout: 60s
        script: |
          echo "Waiting for application to be ready..."
          
          # ìµœëŒ€ 120ì´ˆ ëŒ€ê¸° (2ë¶„)
          for i in {1..24}; do
            if curl -f http://localhost:8080/api/v1/test/health > /dev/null 2>&1; then
              echo "âœ… Health check passed!"
              echo "ðŸš€ Deployment successful!"
              
              # ì• í”Œë¦¬ì¼€ì´ì…˜ ì •ë³´ ì¶œë ¥
              echo "--- Deployment Info ---"
              echo "Time: $(date)"
              echo "Process ID: $(pgrep -f 'carefreepass.*jar')"
              echo "Port 8080 status: $(netstat -tlnp 2>/dev/null | grep :8080 || echo 'Not found')"
              
              # ê°„ë‹¨í•œ API í…ŒìŠ¤íŠ¸
              echo "--- API Test ---"
              curl -s http://localhost:8080/api/v1/test/health | head -100
              
              exit 0
            else
              echo "Health check attempt $i failed, waiting 5 seconds..."
              sleep 5
            fi
          done
          
          echo "âŒ Health check failed after 2 minutes"
          echo "--- Process Status ---"
          pgrep -f 'carefreepass.*jar' || echo "No process found"
          
          echo "--- Port Status ---"
          netstat -tlnp 2>/dev/null | grep :8080 || echo "Port 8080 not in use"
          
          echo "--- Recent Logs ---"
          tail -n 50 /opt/carefreepass/application.log || echo "No log file found"
          
          exit 1