<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FCM ì•Œë¦¼ í…ŒìŠ¤íŠ¸ í˜ì´ì§€</title>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
        import { getMessaging, getToken, onMessage } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging.js';
        
        // Firebase ì„¤ì • (google-services.jsonì—ì„œ ì¶”ì¶œ)
        const firebaseConfig = {
            apiKey: "AIzaSyC-mtXiQdWICXo9OhKwVx01qxXqbAoCAj8",
            authDomain: "hackerton-fcm.firebaseapp.com",
            projectId: "hackerton-fcm", 
            storageBucket: "hackerton-fcm.firebasestorage.app",
            messagingSenderId: "67081294208",
            appId: "1:67081294208:android:01b8489bb9f2008d6f7165"
        };
        
        // Firebase ì´ˆê¸°í™”
        const app = initializeApp(firebaseConfig);
        const messaging = getMessaging(app);
        
        // FCM í† í° ìƒì„± ë° ë“±ë¡ í•¨ìˆ˜
        window.generateAndRegisterFCMToken = async function() {
            try {
                // ì•Œë¦¼ ê¶Œí•œ ìš”ì²­
                const permission = await Notification.requestPermission();
                if (permission !== 'granted') {
                    throw new Error('ì•Œë¦¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                }
                
                // Service Worker ë“±ë¡
                if ('serviceWorker' in navigator) {
                    const registration = await navigator.serviceWorker.register('/firebase-messaging-sw.js');
                    console.log('Service Worker ë“±ë¡ ì„±ê³µ:', registration);
                    
                    // Service Workerê°€ í™œì„±í™”ë  ë•Œê¹Œì§€ ëŒ€ê¸°
                    await navigator.serviceWorker.ready;
                }
                
                // FCM í† í° ìƒì„± (ì‹¤ì œ VAPID í‚¤ ì‚¬ìš©)
                const currentToken = await getToken(messaging, {
                    vapidKey: 'BO0E5srhJZcO686JAgCl94NqeWmm8YRE0TSfHbukbeyosncpcMxgh9Td3OQZJ99joHOlTm2LC9CFPvbuK99xUNM'
                });
                
                if (currentToken) {
                    document.getElementById('fcmTokenDisplay').innerHTML = 
                        `<strong>âœ… ìƒì„±ëœ FCM í† í°:</strong><br><code style="word-break: break-all; background: #f0f0f0; padding: 5px; display: block; margin-top: 5px;">${currentToken}</code>`;
                    
                    // FCM í† í°ì„ ì…ë ¥ë€ì—ë„ ìë™ ì…ë ¥
                    document.getElementById('fcmToken').value = currentToken;
                    
                    // FCM í† í° ìƒì„±ë§Œ ì™„ë£Œ (ìˆ˜ë™ ë“±ë¡ í•„ìš”)
                    console.log('FCM í† í° ìƒì„± ì™„ë£Œ. ìˆ˜ë™ìœ¼ë¡œ ë“±ë¡í•´ì£¼ì„¸ìš”.');
                    return currentToken;
                } else {
                    throw new Error('FCM í† í° ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                }
            } catch (error) {
                console.error('FCM í† í° ìƒì„± ì˜¤ë¥˜:', error);
                document.getElementById('fcmTokenDisplay').innerHTML = 
                    `<strong style="color: red;">âŒ ì˜¤ë¥˜:</strong> ${error.message}`;
            }
        };
        
        // ë©”ì‹œì§€ ìˆ˜ì‹  ë¦¬ìŠ¤ë„ˆ
        onMessage(messaging, (payload) => {
            console.log('FCM ë©”ì‹œì§€ ìˆ˜ì‹ :', payload);
            
            // ì•Œë¦¼ í‘œì‹œ
            if (payload.notification) {
                new Notification(payload.notification.title || 'ì•Œë¦¼', {
                    body: payload.notification.body,
                    icon: '/favicon.ico'
                });
            }
            
            // í™”ë©´ì— ì•Œë¦¼ í‘œì‹œ
            const alertDiv = document.createElement('div');
            alertDiv.style.cssText = `
                position: fixed; top: 20px; right: 20px; 
                background: #4CAF50; color: white; 
                padding: 15px; border-radius: 5px; 
                box-shadow: 0 2px 10px rgba(0,0,0,0.3); 
                z-index: 1000; max-width: 300px;
            `;
            alertDiv.innerHTML = `
                <strong>ğŸ“¢ FCM ì•Œë¦¼ ìˆ˜ì‹ !</strong><br>
                ì œëª©: ${payload.notification?.title || 'ì œëª© ì—†ìŒ'}<br>
                ë‚´ìš©: ${payload.notification?.body || 'ë‚´ìš© ì—†ìŒ'}
            `;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => alertDiv.remove(), 5000);
        });
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            color: #2c5282;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }

        .header p {
            color: #666;
            font-size: 1.1rem;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
        }

        .card h2 {
            color: #2c5282;
            margin-bottom: 20px;
            font-size: 1.5rem;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #3182ce;
            box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
        }

        .btn {
            background: #3182ce;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            width: 100%;
            margin-top: 10px;
        }

        .btn:hover {
            background: #2c5282;
            transform: translateY(-1px);
        }

        .btn.danger {
            background: #e53e3e;
        }

        .btn.danger:hover {
            background: #c53030;
        }

        .btn.success {
            background: #38a169;
        }

        .btn.success:hover {
            background: #2f855a;
        }

        .patients-table {
            grid-column: 1 / -1;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .table th, .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .table th {
            background: #f7fafc;
            font-weight: 600;
            color: #4a5568;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-align: center;
        }

        .status-booked {
            background: #bee3f8;
            color: #2b6cb0;
        }

        .status-arrived {
            background: #c6f6d5;
            color: #2f855a;
        }

        .status-called {
            background: #fed7d7;
            color: #c53030;
        }

        .status-completed {
            background: #e2e8f0;
            color: #4a5568;
        }

        .call-btn {
            padding: 6px 16px;
            font-size: 12px;
            margin: 0;
            width: auto;
        }

        .call-btn:disabled {
            background: #e2e8f0;
            color: #a0aec0;
            cursor: not-allowed;
        }

        .response {
            margin-top: 15px;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
        }

        .response.success {
            background: #f0fff4;
            border: 1px solid #9ae6b4;
            color: #22543d;
        }

        .response.error {
            background: #fed7d7;
            border: 1px solid #feb2b2;
            color: #742a2a;
        }

        .api-info {
            grid-column: 1 / -1;
            background: #edf2f7;
            border-left: 4px solid #3182ce;
        }

        .api-info h3 {
            color: #2d3748;
            margin-bottom: 15px;
        }

        .api-info code {
            background: #2d3748;
            color: #e2e8f0;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
        }

        .api-info pre {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 12px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”” CareFreePass FCM í…ŒìŠ¤íŠ¸</h1>
            <p>ì›¹ ê´€ë¦¬ììš© í™˜ì í˜¸ì¶œ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸</p>
        </div>

        <div class="dashboard">
            <!-- FCM í† í° ë“±ë¡ -->
            <div class="card">
                <h2>ğŸ“± FCM í† í° ë“±ë¡</h2>
                <div class="form-group">
                    <label for="memberId">íšŒì› ID</label>
                    <input type="number" id="memberId" placeholder="1" value="1">
                </div>
                <div class="form-group">
                    <label for="fcmToken">FCM í† í°</label>
                    <textarea id="fcmToken" rows="3" placeholder="ì—¬ê¸°ì— FCM í† í°ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                    <div style="margin-top: 10px;">
                        <button type="button" onclick="generateAndRegisterFCMToken()" class="btn btn-secondary">
                            ğŸ”„ ì‹¤ì œ FCM í† í° ìƒì„±í•˜ê¸°
                        </button>
                    </div>
                    <div id="fcmTokenDisplay" style="margin-top: 10px; font-size: 0.9rem; color: #666;"></div>
                </div>
                <div class="form-group">
                    <label for="deviceType">ê¸°ê¸° íƒ€ì…</label>
                    <select id="deviceType">
                        <option value="ANDROID">Android</option>
                        <option value="IOS">iOS</option>
                    </select>
                </div>
                <button class="btn" onclick="registerToken()">í† í° ë“±ë¡</button>
                <div id="tokenResponse"></div>
            </div>

            <!-- íšŒì›ê°€ì… -->
            <div class="card">
                <h2>ğŸ‘¤ íšŒì›ê°€ì…</h2>
                <div class="form-group">
                    <label for="userName">ì´ë¦„</label>
                    <input type="text" id="userName" placeholder="ê¹€í™˜ì" value="ê¹€í™˜ì">
                </div>
                <div class="form-group">
                    <label for="userGender">ì„±ë³„</label>
                    <select id="userGender">
                        <option value="ë‚¨ì„±">ë‚¨ì„±</option>
                        <option value="ì—¬ì„±">ì—¬ì„±</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="userBirthDate">ìƒë…„ì›”ì¼ (YYYYMMDD)</label>
                    <input type="text" id="userBirthDate" placeholder="19900315" value="19900315">
                </div>
                <div class="form-group">
                    <label for="userPhoneNumber">ì „í™”ë²ˆí˜¸</label>
                    <input type="text" id="userPhoneNumber" placeholder="01012345678" value="01012345678">
                </div>
                <div class="form-group">
                    <label for="userPassword">ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="userPassword" placeholder="password123!" value="password123!">
                </div>
                <button class="btn success" onclick="signUp()">íšŒì›ê°€ì…</button>
                <div id="signUpResponse"></div>
            </div>

            <!-- ì˜ˆì•½ ìƒì„± -->
            <div class="card">
                <h2>ğŸ“… ì˜ˆì•½ ìƒì„±</h2>
                <div class="form-group">
                    <label for="appointmentMemberId">íšŒì› ID</label>
                    <input type="number" id="appointmentMemberId" placeholder="1" value="1">
                </div>
                <div class="form-group">
                    <label for="hospitalName">ë³‘ì›ëª…</label>
                    <input type="text" id="hospitalName" placeholder="ì„œìš¸ëŒ€ë³‘ì›" value="ì„œìš¸ëŒ€ë³‘ì›">
                </div>
                <div class="form-group">
                    <label for="department">ì§„ë£Œê³¼</label>
                    <select id="department">
                        <option value="ë‚´ê³¼">ë‚´ê³¼</option>
                        <option value="ì •í˜•ì™¸ê³¼">ì •í˜•ì™¸ê³¼</option>
                        <option value="í”¼ë¶€ê³¼">í”¼ë¶€ê³¼</option>
                        <option value="ì´ë¹„ì¸í›„ê³¼">ì´ë¹„ì¸í›„ê³¼</option>
                        <option value="ì•ˆê³¼">ì•ˆê³¼</option>
                        <option value="ì‚°ë¶€ì¸ê³¼">ì‚°ë¶€ì¸ê³¼</option>
                        <option value="ì†Œì•„ê³¼">ì†Œì•„ê³¼</option>
                        <option value="ì •ì‹ ê³¼">ì •ì‹ ê³¼</option>
                        <option value="ì¹˜ê³¼">ì¹˜ê³¼</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="appointmentDate">ì˜ˆì•½ ë‚ ì§œ</label>
                    <input type="date" id="appointmentDate">
                </div>
                <div class="form-group">
                    <label for="appointmentTime">ì˜ˆì•½ ì‹œê°„</label>
                    <input type="time" id="appointmentTime" value="10:30">
                </div>
                <button class="btn success" onclick="createAppointment()">ì˜ˆì•½ ìƒì„±</button>
                <div id="appointmentResponse"></div>
            </div>

            <!-- API ì •ë³´ -->
            <div class="card api-info">
                <h3>ğŸš€ API ì—”ë“œí¬ì¸íŠ¸</h3>
                <p><strong>ì•Œë¦¼ API:</strong> <code>http://localhost:8080/api/v1/notifications</code></p>
                <p><strong>ì˜ˆì•½ API:</strong> <code>http://localhost:8080/api/v1/appointments</code></p>
                
                <h4 style="margin-top: 20px; color: #2d3748;">ì•Œë¦¼ API</h4>
                <ul style="margin: 10px 0; padding-left: 20px;">
                    <li><code>POST /token</code> - FCM í† í° ë“±ë¡</li>
                    <li><code>POST /call</code> - í™˜ì í˜¸ì¶œ (í•µì‹¬)</li>
                    <li><code>GET /history</code> - ì•Œë¦¼ ì´ë ¥ ì¡°íšŒ (ì‹ ê·œ)</li>
                    <li><code>GET /history/appointment/{id}</code> - ì˜ˆì•½ë³„ ì´ë ¥ ì¡°íšŒ</li>
                </ul>

                <h4 style="margin-top: 20px; color: #2d3748;">ì˜ˆì•½ API</h4>
                <ul style="margin: 10px 0; padding-left: 20px;">
                    <li><code>POST /</code> - ì˜ˆì•½ ìƒì„±</li>
                    <li><code>PUT /checkin</code> - ì²´í¬ì¸</li>
                    <li><code>GET /today</code> - ì˜¤ëŠ˜ ì „ì²´ ì˜ˆì•½ ëª©ë¡</li>
                    <li><code>GET /today/waiting</code> - ì˜¤ëŠ˜ ëŒ€ê¸° í™˜ì ëª©ë¡</li>
                    <li><code>PUT /{id}</code> - ì˜ˆì•½ ìˆ˜ì •</li>
                    <li><code>DELETE /{id}</code> - ì˜ˆì•½ ì‚­ì œ</li>
                </ul>

                <h4 style="margin-top: 20px; color: #2d3748;">í™˜ì í˜¸ì¶œ ì˜ˆì‹œ</h4>
                <pre>{
  "appointmentId": 1,
  "roomNumber": "2ë²ˆ ì§„ë£Œì‹¤"
}</pre>
            </div>
        </div>

        <!-- ì˜¤ëŠ˜ ì˜ˆì•½ ëª©ë¡ -->
        <div class="card patients-table">
            <h2>ğŸ‘¥ ì˜¤ëŠ˜ ì˜ˆì•½ í™˜ì ëª©ë¡</h2>
            <button class="btn" onclick="loadTodayAppointments()">ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
            
            <table class="table" id="appointmentsTable">
                <thead>
                    <tr>
                        <th>ì˜ˆì•½ID</th>
                        <th>í™˜ìëª…</th>
                        <th>ë³‘ì›</th>
                        <th>ì§„ë£Œê³¼</th>
                        <th>ì˜ˆì•½ì‹œê°„</th>
                        <th>ìƒíƒœ</th>
                        <th>ì•¡ì…˜</th>
                    </tr>
                </thead>
                <tbody id="appointmentsBody">
                    <tr>
                        <td colspan="7" style="text-align: center; color: #666;">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ë ¤ë©´ ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- ì•Œë¦¼ ì´ë ¥ ì¡°íšŒ -->
        <div class="card patients-table">
            <h2>ğŸ”” ì•Œë¦¼ ì „ì†¡ ì´ë ¥</h2>
            <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
                <label for="historyAppointmentId">ì˜ˆì•½ ID (ì„ íƒ)</label>
                <input type="number" id="historyAppointmentId" placeholder="ì „ì²´ ì´ë ¥ì„ ë³´ë ¤ë©´ ë¹„ì›Œë‘ì„¸ìš”" style="width: 200px;">
                <button class="btn" onclick="loadNotificationHistory()">ì´ë ¥ ì¡°íšŒ</button>
                <button class="btn" onclick="clearNotificationHistory()">ëª©ë¡ ì§€ìš°ê¸°</button>
            </div>
            
            <table class="table" id="notificationHistoryTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>ì˜ˆì•½ID</th>
                        <th>ì œëª©</th>
                        <th>ë‚´ìš©</th>
                        <th>ì„±ê³µì—¬ë¶€</th>
                        <th>ì˜¤ë¥˜ë©”ì‹œì§€</th>
                        <th>ì „ì†¡ì‹œê°„</th>
                    </tr>
                </thead>
                <tbody id="notificationHistoryBody">
                    <tr>
                        <td colspan="7" style="text-align: center; color: #666;">ì´ë ¥ì„ ì¡°íšŒí•˜ë ¤ë©´ 'ì´ë ¥ ì¡°íšŒ' ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // ì˜¤ëŠ˜ ë‚ ì§œ ì„¤ì •
        document.getElementById('appointmentDate').value = new Date().toISOString().split('T')[0];

        // API ê¸°ë³¸ URL
        const BASE_URL = 'http://localhost:8080/api/v1/notifications';
        const APPOINTMENT_URL = 'http://localhost:8080/api/v1/appointments';
        const AUTH_URL = 'http://localhost:8080/api/v1/auth';

        // íšŒì›ê°€ì…
        async function signUp() {
            const data = {
                name: document.getElementById('userName').value,
                gender: document.getElementById('userGender').value,
                birthDate: document.getElementById('userBirthDate').value,
                phoneNumber: document.getElementById('userPhoneNumber').value,
                password: document.getElementById('userPassword').value
            };

            if (!data.name || !data.gender || !data.birthDate || !data.phoneNumber || !data.password) {
                showResponse('signUpResponse', 'ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            try {
                const response = await fetch(`${AUTH_URL}/patient/sign-up`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                if (response.ok) {
                    showResponse('signUpResponse', `íšŒì›ê°€ì… ì„±ê³µ! íšŒì› ID: ${result.data?.memberId || 'í™•ì¸ í•„ìš”'}`, 'success');
                    console.log('íšŒì›ê°€ì… ê²°ê³¼:', result);
                } else {
                    showResponse('signUpResponse', result.message || 'íšŒì›ê°€ì… ì‹¤íŒ¨', 'error');
                }
            } catch (error) {
                showResponse('signUpResponse', 'íšŒì›ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            }
        }

        // FCM í† í° ë“±ë¡
        async function registerToken() {
            const memberId = document.getElementById('memberId').value;
            const fcmToken = document.getElementById('fcmToken').value;
            const deviceType = document.getElementById('deviceType').value;

            if (!memberId || !fcmToken) {
                showResponse('tokenResponse', 'íšŒì› IDì™€ FCM í† í°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            try {
                const response = await fetch(`${BASE_URL}/token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        memberId: parseInt(memberId),
                        fcmToken: fcmToken,
                        deviceType: deviceType
                    })
                });

                const result = await response.json();
                showResponse('tokenResponse', result.message, response.ok ? 'success' : 'error');
            } catch (error) {
                showResponse('tokenResponse', 'í† í° ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            }
        }

        // ì˜ˆì•½ ìƒì„±
        async function createAppointment() {
            const data = {
                memberId: parseInt(document.getElementById('appointmentMemberId').value),
                hospitalName: document.getElementById('hospitalName').value,
                department: document.getElementById('department').value,
                appointmentDate: document.getElementById('appointmentDate').value,
                appointmentTime: document.getElementById('appointmentTime').value
            };

            if (!data.memberId || !data.hospitalName || !data.department || !data.appointmentDate || !data.appointmentTime) {
                showResponse('appointmentResponse', 'í•„ìˆ˜ ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            try {
                const response = await fetch(`${APPOINTMENT_URL}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                showResponse('appointmentResponse', `${result.message} (ì˜ˆì•½ ID: ${result.data})`, response.ok ? 'success' : 'error');
                
                if (response.ok) {
                    setTimeout(loadTodayAppointments, 1000);
                }
            } catch (error) {
                showResponse('appointmentResponse', 'ì˜ˆì•½ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            }
        }

        // ì˜¤ëŠ˜ ì˜ˆì•½ ëª©ë¡ ë¡œë“œ
        async function loadTodayAppointments() {
            try {
                const response = await fetch(`${APPOINTMENT_URL}/today`);
                const result = await response.json();

                const tbody = document.getElementById('appointmentsBody');
                tbody.innerHTML = '';

                if (result.data && result.data.length > 0) {
                    result.data.forEach(appointment => {
                        const row = createAppointmentRow(appointment);
                        tbody.appendChild(row);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666;">ì˜¤ëŠ˜ ì˜ˆì•½ëœ í™˜ìê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                }
            } catch (error) {
                console.error('ì˜ˆì•½ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                const tbody = document.getElementById('appointmentsBody');
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #f56565;">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤</td></tr>';
            }
        }

        // ì˜ˆì•½ í–‰ ìƒì„±
        function createAppointmentRow(appointment) {
            const row = document.createElement('tr');
            
            const statusClass = `status-${appointment.status.toLowerCase()}`;
            const canCallClass = appointment.canCall ? '' : 'disabled';
            
            row.innerHTML = `
                <td>${appointment.appointmentId}</td>
                <td><strong>${appointment.memberName}</strong></td>
                <td>${appointment.hospitalName}</td>
                <td>${appointment.department}</td>
                <td>${appointment.appointmentTime}</td>
                <td><span class="status-badge ${statusClass}">${appointment.statusDescription}</span></td>
                <td>
                    <button class="btn call-btn ${appointment.canCall ? 'danger' : ''}" 
                            onclick="callPatient(${appointment.appointmentId})" 
                            ${appointment.canCall ? '' : 'disabled'}
                            style="margin-bottom: 5px;">
                        ${appointment.canCall ? 'ğŸ“¢ í˜¸ì¶œ' : 'ëŒ€ê¸°ì¤‘'}
                    </button>
                    <br>
                    <button class="btn call-btn" 
                            onclick="showUpdateModal(${appointment.appointmentId}, '${appointment.hospitalName}', '${appointment.department}', '${appointment.appointmentDate}', '${appointment.appointmentTime}')"
                            style="background: #3182ce; font-size: 10px; padding: 4px 8px; margin-right: 5px;">
                        âœï¸ ìˆ˜ì •
                    </button>
                    <button class="btn call-btn" 
                            onclick="deleteAppointment(${appointment.appointmentId})"
                            style="background: #e53e3e; font-size: 10px; padding: 4px 8px;">
                        ğŸ—‘ï¸ ì‚­ì œ
                    </button>
                </td>
            `;
            
            return row;
        }

        // í™˜ì í˜¸ì¶œ
        async function callPatient(appointmentId) {
            if (!confirm('í™˜ìë¥¼ í˜¸ì¶œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                const response = await fetch(`${BASE_URL}/call`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        appointmentId: appointmentId,
                        roomNumber: "ì§„ë£Œì‹¤"
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    alert('í™˜ì í˜¸ì¶œì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ“±');
                    loadTodayAppointments();
                } else {
                    alert('í˜¸ì¶œ ì‹¤íŒ¨: ' + result.message);
                }
            } catch (error) {
                alert('í˜¸ì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ì²´í¬ì¸ (í…ŒìŠ¤íŠ¸ìš©)
        async function checkinAppointment(appointmentId, memberId) {
            try {
                const response = await fetch(`${BASE_URL}/appointments/checkin`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        appointmentId: appointmentId,
                        memberId: memberId
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    alert('ì²´í¬ì¸ ì™„ë£Œ!');
                    loadTodayAppointments();
                } else {
                    alert('ì²´í¬ì¸ ì‹¤íŒ¨: ' + result.message);
                }
            } catch (error) {
                alert('ì²´í¬ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ì˜ˆì•½ ì‚­ì œ
        async function deleteAppointment(appointmentId) {
            if (!confirm('ì˜ˆì•½ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                const response = await fetch(`${APPOINTMENT_URL}/${appointmentId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                
                if (response.ok) {
                    alert('ì˜ˆì•½ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ—‘ï¸');
                    loadTodayAppointments();
                } else {
                    alert('ì‚­ì œ ì‹¤íŒ¨: ' + result.message);
                }
            } catch (error) {
                alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ì‘ë‹µ ë©”ì‹œì§€ í‘œì‹œ
        function showResponse(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="response ${type}">${message}</div>`;
        }

        // ì˜ˆì•½ ìˆ˜ì • ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ë“¤
        function showUpdateModal(appointmentId, hospitalName, department, appointmentDate, appointmentTime) {
            if (document.getElementById('updateModal')) {
                document.getElementById('updateModal').remove();
            }

            const modal = document.createElement('div');
            modal.id = 'updateModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); z-index: 2000;
                display: flex; justify-content: center; align-items: center;
            `;

            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 12px; width: 500px; max-width: 90vw; max-height: 80vh; overflow-y: auto;">
                    <h3 style="margin-bottom: 20px; color: #2c5282;">ì˜ˆì•½ ìˆ˜ì •</h3>
                    
                    <div class="form-group">
                        <label>ë³‘ì›ëª…</label>
                        <input type="text" id="updateHospitalName" value="${hospitalName}">
                    </div>
                    
                    <div class="form-group">
                        <label>ì§„ë£Œê³¼</label>
                        <select id="updateDepartment">
                            <option value="ë‚´ê³¼" ${department === 'ë‚´ê³¼' ? 'selected' : ''}>ë‚´ê³¼</option>
                            <option value="ì •í˜•ì™¸ê³¼" ${department === 'ì •í˜•ì™¸ê³¼' ? 'selected' : ''}>ì •í˜•ì™¸ê³¼</option>
                            <option value="í”¼ë¶€ê³¼" ${department === 'í”¼ë¶€ê³¼' ? 'selected' : ''}>í”¼ë¶€ê³¼</option>
                            <option value="ì´ë¹„ì¸í›„ê³¼" ${department === 'ì´ë¹„ì¸í›„ê³¼' ? 'selected' : ''}>ì´ë¹„ì¸í›„ê³¼</option>
                            <option value="ì•ˆê³¼" ${department === 'ì•ˆê³¼' ? 'selected' : ''}>ì•ˆê³¼</option>
                            <option value="ì‚°ë¶€ì¸ê³¼" ${department === 'ì‚°ë¶€ì¸ê³¼' ? 'selected' : ''}>ì‚°ë¶€ì¸ê³¼</option>
                            <option value="ì†Œì•„ê³¼" ${department === 'ì†Œì•„ê³¼' ? 'selected' : ''}>ì†Œì•„ê³¼</option>
                            <option value="ì •ì‹ ê³¼" ${department === 'ì •ì‹ ê³¼' ? 'selected' : ''}>ì •ì‹ ê³¼</option>
                            <option value="ì¹˜ê³¼" ${department === 'ì¹˜ê³¼' ? 'selected' : ''}>ì¹˜ê³¼</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>ì˜ˆì•½ ë‚ ì§œ</label>
                        <input type="date" id="updateAppointmentDate" value="${appointmentDate}">
                    </div>
                    
                    <div class="form-group">
                        <label>ì˜ˆì•½ ì‹œê°„</label>
                        <input type="time" id="updateAppointmentTime" value="${appointmentTime}">
                    </div>
                    
                    <div style="margin-top: 20px; display: flex; gap: 10px;">
                        <button class="btn success" onclick="updateAppointment(${appointmentId})" style="width: auto; flex: 1;">
                            âœ… ìˆ˜ì •í•˜ê¸°
                        </button>
                        <button class="btn" onclick="closeUpdateModal()" style="width: auto; flex: 1; background: #718096;">
                            âŒ ì·¨ì†Œ
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeUpdateModal();
                }
            });
        }

        function closeUpdateModal() {
            const modal = document.getElementById('updateModal');
            if (modal) {
                modal.remove();
            }
        }

        // ì˜ˆì•½ ìˆ˜ì •
        async function updateAppointment(appointmentId) {
            const data = {
                hospitalName: document.getElementById('updateHospitalName').value,
                department: document.getElementById('updateDepartment').value,
                appointmentDate: document.getElementById('updateAppointmentDate').value,
                appointmentTime: document.getElementById('updateAppointmentTime').value
            };

            if (!data.hospitalName || !data.department || !data.appointmentDate || !data.appointmentTime) {
                alert('í•„ìˆ˜ ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                const response = await fetch(`${APPOINTMENT_URL}/${appointmentId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                
                if (response.ok) {
                    alert('ì˜ˆì•½ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤! âœï¸');
                    closeUpdateModal();
                    loadTodayAppointments();
                } else {
                    alert('ìˆ˜ì • ì‹¤íŒ¨: ' + result.message);
                }
            } catch (error) {
                alert('ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ì•Œë¦¼ ì´ë ¥ ì¡°íšŒ
        async function loadNotificationHistory() {
            const appointmentId = document.getElementById('historyAppointmentId').value;
            const url = appointmentId ? 
                `${BASE_URL}/history?appointmentId=${appointmentId}` : 
                `${BASE_URL}/history`;

            try {
                const response = await fetch(url);
                const result = await response.json();

                if (response.ok && result.data) {
                    displayNotificationHistory(result.data);
                } else {
                    alert('ì´ë ¥ ì¡°íšŒ ì‹¤íŒ¨: ' + result.message);
                }
            } catch (error) {
                console.error('ì•Œë¦¼ ì´ë ¥ ì¡°íšŒ ì˜¤ë¥˜:', error);
                alert('ì´ë ¥ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì•Œë¦¼ ì´ë ¥ í‘œì‹œ
        function displayNotificationHistory(histories) {
            const tbody = document.getElementById('notificationHistoryBody');
            
            if (histories.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666;">ì¡°íšŒëœ ì•Œë¦¼ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                return;
            }

            tbody.innerHTML = histories.map(history => {
                const successBadge = history.isSuccess ? 
                    '<span class="status-badge status-arrived">âœ… ì„±ê³µ</span>' : 
                    '<span class="status-badge status-called">âŒ ì‹¤íŒ¨</span>';
                
                return `
                    <tr>
                        <td>${history.id}</td>
                        <td>${history.appointmentId || '-'}</td>
                        <td>${history.title}</td>
                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;" title="${history.message}">
                            ${history.message}
                        </td>
                        <td>${successBadge}</td>
                        <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis;" title="${history.errorMessage || ''}">
                            ${history.errorMessage || '-'}
                        </td>
                        <td>${new Date(history.createdAt).toLocaleString('ko-KR')}</td>
                    </tr>
                `;
            }).join('');
        }

        // ì•Œë¦¼ ì´ë ¥ ëª©ë¡ ì§€ìš°ê¸°
        function clearNotificationHistory() {
            document.getElementById('notificationHistoryBody').innerHTML = 
                '<tr><td colspan="7" style="text-align: center; color: #666;">ì´ë ¥ì„ ì¡°íšŒí•˜ë ¤ë©´ \'ì´ë ¥ ì¡°íšŒ\' ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</td></tr>';
            document.getElementById('historyAppointmentId').value = '';
        }

        // í˜ì´ì§€ ë¡œë“œì‹œ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        window.onload = function() {
            loadTodayAppointments();
        };
    </script>
</body>
</html>