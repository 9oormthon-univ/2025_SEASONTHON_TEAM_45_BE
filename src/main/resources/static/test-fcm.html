<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FCM 알림 테스트 페이지</title>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
        import { getMessaging, getToken, onMessage } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging.js';
        
        // Firebase 설정 (google-services.json에서 추출)
        const firebaseConfig = {
            apiKey: "AIzaSyC-mtXiQdWICXo9OhKwVx01qxXqbAoCAj8",
            authDomain: "hackerton-fcm.firebaseapp.com",
            projectId: "hackerton-fcm", 
            storageBucket: "hackerton-fcm.firebasestorage.app",
            messagingSenderId: "67081294208",
            appId: "1:67081294208:android:01b8489bb9f2008d6f7165"
        };
        
        // Firebase 초기화
        const app = initializeApp(firebaseConfig);
        const messaging = getMessaging(app);
        
        // FCM 토큰 생성 및 등록 함수
        window.generateAndRegisterFCMToken = async function() {
            try {
                // 알림 권한 요청
                const permission = await Notification.requestPermission();
                if (permission !== 'granted') {
                    throw new Error('알림 권한이 거부되었습니다.');
                }
                
                // Service Worker 등록
                if ('serviceWorker' in navigator) {
                    const registration = await navigator.serviceWorker.register('/firebase-messaging-sw.js');
                    console.log('Service Worker 등록 성공:', registration);
                    
                    // Service Worker가 활성화될 때까지 대기
                    await navigator.serviceWorker.ready;
                }
                
                // FCM 토큰 생성 (실제 VAPID 키 사용)
                const currentToken = await getToken(messaging, {
                    vapidKey: 'BO0E5srhJZcO686JAgCl94NqeWmm8YRE0TSfHbukbeyosncpcMxgh9Td3OQZJ99joHOlTm2LC9CFPvbuK99xUNM'
                });
                
                if (currentToken) {
                    document.getElementById('fcmTokenDisplay').innerHTML = 
                        `<strong>✅ 생성된 FCM 토큰:</strong><br><code style="word-break: break-all; background: #f0f0f0; padding: 5px; display: block; margin-top: 5px;">${currentToken}</code>`;
                    
                    // FCM 토큰을 입력란에도 자동 입력
                    document.getElementById('fcmToken').value = currentToken;
                    
                    // FCM 토큰 생성만 완료 (수동 등록 필요)
                    console.log('FCM 토큰 생성 완료. 수동으로 등록해주세요.');
                    return currentToken;
                } else {
                    throw new Error('FCM 토큰 생성에 실패했습니다. 콘솔을 확인해주세요.');
                }
            } catch (error) {
                console.error('FCM 토큰 생성 오류:', error);
                document.getElementById('fcmTokenDisplay').innerHTML = 
                    `<strong style="color: red;">❌ 오류:</strong> ${error.message}`;
            }
        };
        
        // 메시지 수신 리스너
        onMessage(messaging, (payload) => {
            console.log('FCM 메시지 수신:', payload);
            
            // 알림 표시
            if (payload.notification) {
                new Notification(payload.notification.title || '알림', {
                    body: payload.notification.body,
                    icon: '/favicon.ico'
                });
            }
            
            // 화면에 알림 표시
            const alertDiv = document.createElement('div');
            alertDiv.style.cssText = `
                position: fixed; top: 20px; right: 20px; 
                background: #4CAF50; color: white; 
                padding: 15px; border-radius: 5px; 
                box-shadow: 0 2px 10px rgba(0,0,0,0.3); 
                z-index: 1000; max-width: 300px;
            `;
            alertDiv.innerHTML = `
                <strong>📢 FCM 알림 수신!</strong><br>
                제목: ${payload.notification?.title || '제목 없음'}<br>
                내용: ${payload.notification?.body || '내용 없음'}
            `;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => alertDiv.remove(), 5000);
        });
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            color: #2c5282;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }

        .header p {
            color: #666;
            font-size: 1.1rem;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
        }

        .card h2 {
            color: #2c5282;
            margin-bottom: 20px;
            font-size: 1.5rem;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #3182ce;
            box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
        }

        .btn {
            background: #3182ce;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            width: 100%;
            margin-top: 10px;
        }

        .btn:hover {
            background: #2c5282;
            transform: translateY(-1px);
        }

        .btn.danger {
            background: #e53e3e;
        }

        .btn.danger:hover {
            background: #c53030;
        }

        .btn.success {
            background: #38a169;
        }

        .btn.success:hover {
            background: #2f855a;
        }

        .patients-table {
            grid-column: 1 / -1;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .table th, .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .table th {
            background: #f7fafc;
            font-weight: 600;
            color: #4a5568;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-align: center;
        }

        .status-booked {
            background: #bee3f8;
            color: #2b6cb0;
        }

        .status-arrived {
            background: #c6f6d5;
            color: #2f855a;
        }

        .status-called {
            background: #fed7d7;
            color: #c53030;
        }

        .status-completed {
            background: #e2e8f0;
            color: #4a5568;
        }

        .call-btn {
            padding: 6px 16px;
            font-size: 12px;
            margin: 0;
            width: auto;
        }

        .call-btn:disabled {
            background: #e2e8f0;
            color: #a0aec0;
            cursor: not-allowed;
        }

        .response {
            margin-top: 15px;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
        }

        .response.success {
            background: #f0fff4;
            border: 1px solid #9ae6b4;
            color: #22543d;
        }

        .response.error {
            background: #fed7d7;
            border: 1px solid #feb2b2;
            color: #742a2a;
        }

        .api-info {
            grid-column: 1 / -1;
            background: #edf2f7;
            border-left: 4px solid #3182ce;
        }

        .api-info h3 {
            color: #2d3748;
            margin-bottom: 15px;
        }

        .api-info code {
            background: #2d3748;
            color: #e2e8f0;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
        }

        .api-info pre {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 12px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔔 CareFreePass FCM 테스트</h1>
            <p>웹 관리자용 환자 호출 시스템 테스트</p>
        </div>

        <div class="dashboard">
            <!-- FCM 토큰 등록 -->
            <div class="card">
                <h2>📱 FCM 토큰 등록</h2>
                <div class="form-group">
                    <label for="memberId">회원 ID</label>
                    <input type="number" id="memberId" placeholder="1" value="1">
                </div>
                <div class="form-group">
                    <label for="fcmToken">FCM 토큰</label>
                    <textarea id="fcmToken" rows="3" placeholder="여기에 FCM 토큰을 입력하세요"></textarea>
                    <div style="margin-top: 10px;">
                        <button type="button" onclick="generateAndRegisterFCMToken()" class="btn btn-secondary">
                            🔄 실제 FCM 토큰 생성하기
                        </button>
                    </div>
                    <div id="fcmTokenDisplay" style="margin-top: 10px; font-size: 0.9rem; color: #666;"></div>
                </div>
                <div class="form-group">
                    <label for="deviceType">기기 타입</label>
                    <select id="deviceType">
                        <option value="ANDROID">Android</option>
                        <option value="IOS">iOS</option>
                    </select>
                </div>
                <button class="btn" onclick="registerToken()">토큰 등록</button>
                <div id="tokenResponse"></div>
            </div>

            <!-- 회원가입 -->
            <div class="card">
                <h2>👤 회원가입</h2>
                <div class="form-group">
                    <label for="userName">이름</label>
                    <input type="text" id="userName" placeholder="김환자" value="김환자">
                </div>
                <div class="form-group">
                    <label for="userGender">성별</label>
                    <select id="userGender">
                        <option value="남성">남성</option>
                        <option value="여성">여성</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="userBirthDate">생년월일 (YYYYMMDD)</label>
                    <input type="text" id="userBirthDate" placeholder="19900315" value="19900315">
                </div>
                <div class="form-group">
                    <label for="userPhoneNumber">전화번호</label>
                    <input type="text" id="userPhoneNumber" placeholder="01012345678" value="01012345678">
                </div>
                <div class="form-group">
                    <label for="userPassword">비밀번호</label>
                    <input type="password" id="userPassword" placeholder="password123!" value="password123!">
                </div>
                <button class="btn success" onclick="signUp()">회원가입</button>
                <div id="signUpResponse"></div>
            </div>

            <!-- 예약 생성 -->
            <div class="card">
                <h2>📅 예약 생성</h2>
                <div class="form-group">
                    <label for="appointmentMemberId">회원 ID</label>
                    <input type="number" id="appointmentMemberId" placeholder="1" value="1">
                </div>
                <div class="form-group">
                    <label for="hospitalName">병원명</label>
                    <input type="text" id="hospitalName" placeholder="서울대병원" value="서울대병원">
                </div>
                <div class="form-group">
                    <label for="department">진료과</label>
                    <select id="department">
                        <option value="내과">내과</option>
                        <option value="정형외과">정형외과</option>
                        <option value="피부과">피부과</option>
                        <option value="이비인후과">이비인후과</option>
                        <option value="안과">안과</option>
                        <option value="산부인과">산부인과</option>
                        <option value="소아과">소아과</option>
                        <option value="정신과">정신과</option>
                        <option value="치과">치과</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="appointmentDate">예약 날짜</label>
                    <input type="date" id="appointmentDate">
                </div>
                <div class="form-group">
                    <label for="appointmentTime">예약 시간</label>
                    <input type="time" id="appointmentTime" value="10:30">
                </div>
                <button class="btn success" onclick="createAppointment()">예약 생성</button>
                <div id="appointmentResponse"></div>
            </div>

            <!-- API 정보 -->
            <div class="card api-info">
                <h3>🚀 API 엔드포인트</h3>
                <p><strong>알림 API:</strong> <code>http://localhost:8080/api/v1/notifications</code></p>
                <p><strong>예약 API:</strong> <code>http://localhost:8080/api/v1/appointments</code></p>
                
                <h4 style="margin-top: 20px; color: #2d3748;">알림 API</h4>
                <ul style="margin: 10px 0; padding-left: 20px;">
                    <li><code>POST /token</code> - FCM 토큰 등록</li>
                    <li><code>POST /call</code> - 환자 호출 (핵심)</li>
                    <li><code>GET /history</code> - 알림 이력 조회 (신규)</li>
                    <li><code>GET /history/appointment/{id}</code> - 예약별 이력 조회</li>
                </ul>

                <h4 style="margin-top: 20px; color: #2d3748;">예약 API</h4>
                <ul style="margin: 10px 0; padding-left: 20px;">
                    <li><code>POST /</code> - 예약 생성</li>
                    <li><code>PUT /checkin</code> - 체크인</li>
                    <li><code>GET /today</code> - 오늘 전체 예약 목록</li>
                    <li><code>GET /today/waiting</code> - 오늘 대기 환자 목록</li>
                    <li><code>PUT /{id}</code> - 예약 수정</li>
                    <li><code>DELETE /{id}</code> - 예약 삭제</li>
                </ul>

                <h4 style="margin-top: 20px; color: #2d3748;">환자 호출 예시</h4>
                <pre>{
  "appointmentId": 1,
  "roomNumber": "2번 진료실"
}</pre>
            </div>
        </div>

        <!-- 오늘 예약 목록 -->
        <div class="card patients-table">
            <h2>👥 오늘 예약 환자 목록</h2>
            <button class="btn" onclick="loadTodayAppointments()">목록 새로고침</button>
            
            <table class="table" id="appointmentsTable">
                <thead>
                    <tr>
                        <th>예약ID</th>
                        <th>환자명</th>
                        <th>병원</th>
                        <th>진료과</th>
                        <th>예약시간</th>
                        <th>상태</th>
                        <th>액션</th>
                    </tr>
                </thead>
                <tbody id="appointmentsBody">
                    <tr>
                        <td colspan="7" style="text-align: center; color: #666;">목록을 불러오려면 새로고침 버튼을 클릭하세요</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- 알림 이력 조회 -->
        <div class="card patients-table">
            <h2>🔔 알림 전송 이력</h2>
            <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
                <label for="historyAppointmentId">예약 ID (선택)</label>
                <input type="number" id="historyAppointmentId" placeholder="전체 이력을 보려면 비워두세요" style="width: 200px;">
                <button class="btn" onclick="loadNotificationHistory()">이력 조회</button>
                <button class="btn" onclick="clearNotificationHistory()">목록 지우기</button>
            </div>
            
            <table class="table" id="notificationHistoryTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>예약ID</th>
                        <th>제목</th>
                        <th>내용</th>
                        <th>성공여부</th>
                        <th>오류메시지</th>
                        <th>전송시간</th>
                    </tr>
                </thead>
                <tbody id="notificationHistoryBody">
                    <tr>
                        <td colspan="7" style="text-align: center; color: #666;">이력을 조회하려면 '이력 조회' 버튼을 클릭하세요</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // 오늘 날짜 설정
        document.getElementById('appointmentDate').value = new Date().toISOString().split('T')[0];

        // API 기본 URL
        const BASE_URL = 'http://localhost:8080/api/v1/notifications';
        const APPOINTMENT_URL = 'http://localhost:8080/api/v1/appointments';
        const AUTH_URL = 'http://localhost:8080/api/v1/auth';

        // 회원가입
        async function signUp() {
            const data = {
                name: document.getElementById('userName').value,
                gender: document.getElementById('userGender').value,
                birthDate: document.getElementById('userBirthDate').value,
                phoneNumber: document.getElementById('userPhoneNumber').value,
                password: document.getElementById('userPassword').value
            };

            if (!data.name || !data.gender || !data.birthDate || !data.phoneNumber || !data.password) {
                showResponse('signUpResponse', '모든 필드를 입력해주세요.', 'error');
                return;
            }

            try {
                const response = await fetch(`${AUTH_URL}/patient/sign-up`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                if (response.ok) {
                    showResponse('signUpResponse', `회원가입 성공! 회원 ID: ${result.data?.memberId || '확인 필요'}`, 'success');
                    console.log('회원가입 결과:', result);
                } else {
                    showResponse('signUpResponse', result.message || '회원가입 실패', 'error');
                }
            } catch (error) {
                showResponse('signUpResponse', '회원가입에 실패했습니다: ' + error.message, 'error');
            }
        }

        // FCM 토큰 등록
        async function registerToken() {
            const memberId = document.getElementById('memberId').value;
            const fcmToken = document.getElementById('fcmToken').value;
            const deviceType = document.getElementById('deviceType').value;

            if (!memberId || !fcmToken) {
                showResponse('tokenResponse', '회원 ID와 FCM 토큰을 입력해주세요.', 'error');
                return;
            }

            try {
                const response = await fetch(`${BASE_URL}/token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        memberId: parseInt(memberId),
                        fcmToken: fcmToken,
                        deviceType: deviceType
                    })
                });

                const result = await response.json();
                showResponse('tokenResponse', result.message, response.ok ? 'success' : 'error');
            } catch (error) {
                showResponse('tokenResponse', '토큰 등록에 실패했습니다: ' + error.message, 'error');
            }
        }

        // 예약 생성
        async function createAppointment() {
            const data = {
                memberId: parseInt(document.getElementById('appointmentMemberId').value),
                hospitalName: document.getElementById('hospitalName').value,
                department: document.getElementById('department').value,
                appointmentDate: document.getElementById('appointmentDate').value,
                appointmentTime: document.getElementById('appointmentTime').value
            };

            if (!data.memberId || !data.hospitalName || !data.department || !data.appointmentDate || !data.appointmentTime) {
                showResponse('appointmentResponse', '필수 정보를 모두 입력해주세요.', 'error');
                return;
            }

            try {
                const response = await fetch(`${APPOINTMENT_URL}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                showResponse('appointmentResponse', `${result.message} (예약 ID: ${result.data})`, response.ok ? 'success' : 'error');
                
                if (response.ok) {
                    setTimeout(loadTodayAppointments, 1000);
                }
            } catch (error) {
                showResponse('appointmentResponse', '예약 생성에 실패했습니다: ' + error.message, 'error');
            }
        }

        // 오늘 예약 목록 로드
        async function loadTodayAppointments() {
            try {
                const response = await fetch(`${APPOINTMENT_URL}/today`);
                const result = await response.json();

                const tbody = document.getElementById('appointmentsBody');
                tbody.innerHTML = '';

                if (result.data && result.data.length > 0) {
                    result.data.forEach(appointment => {
                        const row = createAppointmentRow(appointment);
                        tbody.appendChild(row);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666;">오늘 예약된 환자가 없습니다</td></tr>';
                }
            } catch (error) {
                console.error('예약 목록 로드 실패:', error);
                const tbody = document.getElementById('appointmentsBody');
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #f56565;">목록을 불러오는데 실패했습니다</td></tr>';
            }
        }

        // 예약 행 생성
        function createAppointmentRow(appointment) {
            const row = document.createElement('tr');
            
            const statusClass = `status-${appointment.status.toLowerCase()}`;
            const canCallClass = appointment.canCall ? '' : 'disabled';
            
            row.innerHTML = `
                <td>${appointment.appointmentId}</td>
                <td><strong>${appointment.memberName}</strong></td>
                <td>${appointment.hospitalName}</td>
                <td>${appointment.department}</td>
                <td>${appointment.appointmentTime}</td>
                <td><span class="status-badge ${statusClass}">${appointment.statusDescription}</span></td>
                <td>
                    <button class="btn call-btn ${appointment.canCall ? 'danger' : ''}" 
                            onclick="callPatient(${appointment.appointmentId})" 
                            ${appointment.canCall ? '' : 'disabled'}
                            style="margin-bottom: 5px;">
                        ${appointment.canCall ? '📢 호출' : '대기중'}
                    </button>
                    <br>
                    <button class="btn call-btn" 
                            onclick="showUpdateModal(${appointment.appointmentId}, '${appointment.hospitalName}', '${appointment.department}', '${appointment.appointmentDate}', '${appointment.appointmentTime}')"
                            style="background: #3182ce; font-size: 10px; padding: 4px 8px; margin-right: 5px;">
                        ✏️ 수정
                    </button>
                    <button class="btn call-btn" 
                            onclick="deleteAppointment(${appointment.appointmentId})"
                            style="background: #e53e3e; font-size: 10px; padding: 4px 8px;">
                        🗑️ 삭제
                    </button>
                </td>
            `;
            
            return row;
        }

        // 환자 호출
        async function callPatient(appointmentId) {
            if (!confirm('환자를 호출하시겠습니까?')) return;

            try {
                const response = await fetch(`${BASE_URL}/call`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        appointmentId: appointmentId,
                        roomNumber: "진료실"
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    alert('환자 호출이 완료되었습니다! 📱');
                    loadTodayAppointments();
                } else {
                    alert('호출 실패: ' + result.message);
                }
            } catch (error) {
                alert('호출에 실패했습니다: ' + error.message);
            }
        }

        // 체크인 (테스트용)
        async function checkinAppointment(appointmentId, memberId) {
            try {
                const response = await fetch(`${BASE_URL}/appointments/checkin`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        appointmentId: appointmentId,
                        memberId: memberId
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    alert('체크인 완료!');
                    loadTodayAppointments();
                } else {
                    alert('체크인 실패: ' + result.message);
                }
            } catch (error) {
                alert('체크인에 실패했습니다: ' + error.message);
            }
        }

        // 예약 삭제
        async function deleteAppointment(appointmentId) {
            if (!confirm('예약을 삭제하시겠습니까?')) return;

            try {
                const response = await fetch(`${APPOINTMENT_URL}/${appointmentId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                
                if (response.ok) {
                    alert('예약이 삭제되었습니다! 🗑️');
                    loadTodayAppointments();
                } else {
                    alert('삭제 실패: ' + result.message);
                }
            } catch (error) {
                alert('삭제에 실패했습니다: ' + error.message);
            }
        }

        // 응답 메시지 표시
        function showResponse(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="response ${type}">${message}</div>`;
        }

        // 예약 수정 모달 관련 함수들
        function showUpdateModal(appointmentId, hospitalName, department, appointmentDate, appointmentTime) {
            if (document.getElementById('updateModal')) {
                document.getElementById('updateModal').remove();
            }

            const modal = document.createElement('div');
            modal.id = 'updateModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); z-index: 2000;
                display: flex; justify-content: center; align-items: center;
            `;

            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 12px; width: 500px; max-width: 90vw; max-height: 80vh; overflow-y: auto;">
                    <h3 style="margin-bottom: 20px; color: #2c5282;">예약 수정</h3>
                    
                    <div class="form-group">
                        <label>병원명</label>
                        <input type="text" id="updateHospitalName" value="${hospitalName}">
                    </div>
                    
                    <div class="form-group">
                        <label>진료과</label>
                        <select id="updateDepartment">
                            <option value="내과" ${department === '내과' ? 'selected' : ''}>내과</option>
                            <option value="정형외과" ${department === '정형외과' ? 'selected' : ''}>정형외과</option>
                            <option value="피부과" ${department === '피부과' ? 'selected' : ''}>피부과</option>
                            <option value="이비인후과" ${department === '이비인후과' ? 'selected' : ''}>이비인후과</option>
                            <option value="안과" ${department === '안과' ? 'selected' : ''}>안과</option>
                            <option value="산부인과" ${department === '산부인과' ? 'selected' : ''}>산부인과</option>
                            <option value="소아과" ${department === '소아과' ? 'selected' : ''}>소아과</option>
                            <option value="정신과" ${department === '정신과' ? 'selected' : ''}>정신과</option>
                            <option value="치과" ${department === '치과' ? 'selected' : ''}>치과</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>예약 날짜</label>
                        <input type="date" id="updateAppointmentDate" value="${appointmentDate}">
                    </div>
                    
                    <div class="form-group">
                        <label>예약 시간</label>
                        <input type="time" id="updateAppointmentTime" value="${appointmentTime}">
                    </div>
                    
                    <div style="margin-top: 20px; display: flex; gap: 10px;">
                        <button class="btn success" onclick="updateAppointment(${appointmentId})" style="width: auto; flex: 1;">
                            ✅ 수정하기
                        </button>
                        <button class="btn" onclick="closeUpdateModal()" style="width: auto; flex: 1; background: #718096;">
                            ❌ 취소
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // 모달 외부 클릭시 닫기
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeUpdateModal();
                }
            });
        }

        function closeUpdateModal() {
            const modal = document.getElementById('updateModal');
            if (modal) {
                modal.remove();
            }
        }

        // 예약 수정
        async function updateAppointment(appointmentId) {
            const data = {
                hospitalName: document.getElementById('updateHospitalName').value,
                department: document.getElementById('updateDepartment').value,
                appointmentDate: document.getElementById('updateAppointmentDate').value,
                appointmentTime: document.getElementById('updateAppointmentTime').value
            };

            if (!data.hospitalName || !data.department || !data.appointmentDate || !data.appointmentTime) {
                alert('필수 정보를 모두 입력해주세요.');
                return;
            }

            try {
                const response = await fetch(`${APPOINTMENT_URL}/${appointmentId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                
                if (response.ok) {
                    alert('예약이 수정되었습니다! ✏️');
                    closeUpdateModal();
                    loadTodayAppointments();
                } else {
                    alert('수정 실패: ' + result.message);
                }
            } catch (error) {
                alert('수정에 실패했습니다: ' + error.message);
            }
        }

        // 알림 이력 조회
        async function loadNotificationHistory() {
            const appointmentId = document.getElementById('historyAppointmentId').value;
            const url = appointmentId ? 
                `${BASE_URL}/history?appointmentId=${appointmentId}` : 
                `${BASE_URL}/history`;

            try {
                const response = await fetch(url);
                const result = await response.json();

                if (response.ok && result.data) {
                    displayNotificationHistory(result.data);
                } else {
                    alert('이력 조회 실패: ' + result.message);
                }
            } catch (error) {
                console.error('알림 이력 조회 오류:', error);
                alert('이력 조회 중 오류가 발생했습니다.');
            }
        }

        // 알림 이력 표시
        function displayNotificationHistory(histories) {
            const tbody = document.getElementById('notificationHistoryBody');
            
            if (histories.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666;">조회된 알림 이력이 없습니다</td></tr>';
                return;
            }

            tbody.innerHTML = histories.map(history => {
                const successBadge = history.isSuccess ? 
                    '<span class="status-badge status-arrived">✅ 성공</span>' : 
                    '<span class="status-badge status-called">❌ 실패</span>';
                
                return `
                    <tr>
                        <td>${history.id}</td>
                        <td>${history.appointmentId || '-'}</td>
                        <td>${history.title}</td>
                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;" title="${history.message}">
                            ${history.message}
                        </td>
                        <td>${successBadge}</td>
                        <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis;" title="${history.errorMessage || ''}">
                            ${history.errorMessage || '-'}
                        </td>
                        <td>${new Date(history.createdAt).toLocaleString('ko-KR')}</td>
                    </tr>
                `;
            }).join('');
        }

        // 알림 이력 목록 지우기
        function clearNotificationHistory() {
            document.getElementById('notificationHistoryBody').innerHTML = 
                '<tr><td colspan="7" style="text-align: center; color: #666;">이력을 조회하려면 \'이력 조회\' 버튼을 클릭하세요</td></tr>';
            document.getElementById('historyAppointmentId').value = '';
        }

        // 페이지 로드시 목록 불러오기
        window.onload = function() {
            loadTodayAppointments();
        };
    </script>
</body>
</html>