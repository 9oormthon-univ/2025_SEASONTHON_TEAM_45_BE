<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CareFreePass ì™„ì „ í…ŒìŠ¤íŠ¸ í˜ì´ì§€</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .header {
            text-align: center;
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        .header h1 {
            margin: 0;
            font-size: 2.5em;
        }
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .current-user {
            font-weight: bold;
            color: #333;
        }
        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .test-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        .test-card:hover {
            transform: translateY(-5px);
            border-color: #4CAF50;
        }
        .test-card h3 {
            color: #4CAF50;
            margin-top: 0;
            font-size: 1.3em;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
        }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: #4CAF50;
        }
        .btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin: 5px;
            transition: all 0.3s;
        }
        .btn:hover {
            background: #45a049;
            transform: translateY(-2px);
        }
        .btn-secondary {
            background: #6c757d;
        }
        .btn-secondary:hover {
            background: #545b62;
        }
        .response {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            min-height: 50px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
        }
        .response.success {
            background: #d1edda;
            border-color: #28a745;
            color: #155724;
        }
        .response.error {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }
        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        .auth-status {
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
        }
        .auth-status.logged-in {
            background: #d1edda;
            color: #155724;
        }
        .auth-status.logged-out {
            background: #f8d7da;
            color: #721c24;
        }
        /* Chat Window Styles */
        #chatResponse.chat-window {
            height: 300px;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 10px;
            overflow-y: scroll;
            margin-bottom: 10px;
            background-color: #f9f9f9;
            white-space: normal; /* Override for chat */
        }
        .chat-message-item {
            display: flex;
            flex-direction: column;
            margin-bottom: 10px;
        }
        .chat-message-bubble {
            padding: 8px 12px;
            border-radius: 15px;
            max-width: 80%;
            word-wrap: break-word;
        }
        .chat-message-item.user {
            align-items: flex-end;
        }
        .chat-message-item.user .chat-message-bubble {
            background-color: #4CAF50;
            color: white;
            border-bottom-right-radius: 3px;
        }
        .chat-message-item.ai {
            align-items: flex-start;
        }
        .chat-message-item.ai .chat-message-bubble {
            background-color: #e4e6eb;
            color: #333;
            border-bottom-left-radius: 3px;
        }
        .chat-message-item.system .chat-message-bubble {
            background-color: #fffbe6;
            color: #8a6d3b;
            font-style: italic;
            font-size: 0.9em;
            align-self: center;
            text-align: center;
        }
        .chat-message-item.system-error .chat-message-bubble {
            background-color: #f2dede;
            color: #a94442;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¥ CareFreePass ì™„ì „ í…ŒìŠ¤íŠ¸</h1>
            <p>ë³‘ì› ì˜ˆì•½ ì‹œìŠ¤í…œ ì „ì²´ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸</p>
        </div>

        <div class="status-bar">
            <div class="auth-status logged-out" id="authStatus">ë¡œê·¸ì•„ì›ƒ ìƒíƒœ</div>
            <div class="current-user" id="currentUser">ë¡œê·¸ì¸í•˜ì„¸ìš”</div>
            <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>

        <div class="quick-actions">
            <button class="btn" onclick="quickPatientSignup()">ë¹ ë¥¸ í™˜ì ê°€ì…</button>
            <button class="btn" onclick="quickPatientLogin()">ë¹ ë¥¸ í™˜ì ë¡œê·¸ì¸</button>
            <button class="btn" onclick="quickAdminSignup()">ë¹ ë¥¸ ê´€ë¦¬ì ê°€ì…</button>
            <button class="btn" onclick="quickAdminLogin()">ë¹ ë¥¸ ê´€ë¦¬ì ë¡œê·¸ì¸</button>
            <button class="btn btn-secondary" onclick="clearAll()">ì „ì²´ ì´ˆê¸°í™”</button>
        </div>

        <div class="test-grid">
            <!-- í™˜ì íšŒì›ê°€ì… -->
            <div class="test-card">
                <h3>ğŸ‘¤ í™˜ì íšŒì›ê°€ì…</h3>
                <div class="form-group">
                    <label>ì´ë¦„</label>
                    <input type="text" id="patientName" value="ê¹€í™˜ì">
                </div>
                <div class="form-group">
                    <label>ì„±ë³„</label>
                    <select id="patientGender">
                        <option value="ë‚¨ì„±">ë‚¨ì„±</option>
                        <option value="ì—¬ì„±">ì—¬ì„±</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ìƒë…„ì›”ì¼ (YYYYMMDD)</label>
                    <input type="text" id="patientBirthDate" value="19901201">
                </div>
                <div class="form-group">
                    <label>ì „í™”ë²ˆí˜¸</label>
                    <input type="text" id="patientPhone" value="01012345678">
                </div>
                <div class="form-group">
                    <label>ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="patientPassword" value="testPass123!">
                </div>
                <button class="btn" onclick="patientSignup()">íšŒì›ê°€ì…</button>
                <div class="response" id="patientSignupResponse"></div>
            </div>

            <!-- í™˜ì ë¡œê·¸ì¸ -->
            <div class="test-card">
                <h3>ğŸ”‘ í™˜ì ë¡œê·¸ì¸</h3>
                <div class="form-group">
                    <label>ì „í™”ë²ˆí˜¸</label>
                    <input type="text" id="patientLoginPhone" value="01012345678">
                </div>
                <div class="form-group">
                    <label>ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="patientLoginPassword" value="testPass123!">
                </div>
                <button class="btn" onclick="patientLogin()">ë¡œê·¸ì¸</button>
                <div class="response" id="patientLoginResponse"></div>
            </div>

            <!-- ë³‘ì›ê´€ë¦¬ì íšŒì›ê°€ì… -->
            <div class="test-card">
                <h3>ğŸ¥ ë³‘ì›ê´€ë¦¬ì íšŒì›ê°€ì…</h3>
                <div class="form-group">
                    <label>ê´€ë¦¬ì ì´ë¦„</label>
                    <input type="text" id="adminName" value="ê¹€ê´€ë¦¬ì">
                </div>
                <div class="form-group">
                    <label>ì´ë©”ì¼</label>
                    <input type="email" id="adminEmail" value="admin2@hospital.com">
                </div>
                <div class="form-group">
                    <label>ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="adminPassword" value="adminPass123!">
                </div>
                <div class="form-group">
                    <label>ë³‘ì›ëª…</label>
                    <input type="text" id="hospitalName" value="êµ¬ë¦„ëŒ€ë³‘ì›">
                </div>
                <div class="form-group">
                    <label>ë³‘ì›ì£¼ì†Œ</label>
                    <input type="text" id="hospitalAddress" value="ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ ë³‘ì›ë¡œ 123">
                </div>
                <button class="btn" onclick="adminSignup()">ê´€ë¦¬ì ê°€ì…</button>
                <div class="response" id="adminSignupResponse"></div>
            </div>

            <!-- ë³‘ì›ê´€ë¦¬ì ë¡œê·¸ì¸ -->
            <div class="test-card">
                <h3>ğŸ”‘ ê´€ë¦¬ì ë¡œê·¸ì¸</h3>
                <div class="form-group">
                    <label>ì´ë©”ì¼</label>
                    <input type="email" id="adminLoginEmail" value="admin2@hospital.com">
                </div>
                <div class="form-group">
                    <label>ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="adminLoginPassword" value="adminPass123!">
                </div>
                <button class="btn" onclick="adminLogin()">ë¡œê·¸ì¸</button>
                <div class="response" id="adminLoginResponse"></div>
            </div>

            <!-- AI ì±—ë´‡ & ì˜ˆì•½ í†µí•© -->
            <div class="test-card" style="grid-column: 1 / -1; max-height: 600px;">
                <h3>ğŸ¤– AI ì±—ë´‡ & ìŠ¤ë§ˆíŠ¸ ì˜ˆì•½</h3>
                <div class="chat-container" style="display: flex; gap: 20px; height: 500px;">
                    <!-- ì±„íŒ… ì˜ì—­ -->
                    <div style="flex: 2; display: flex; flex-direction: column;">
                        <div class="response chat-window" id="chatResponse" style="flex: 1; overflow-y: auto; height: 400px; border: 2px solid #e9ecef; border-radius: 10px; padding: 15px; margin-bottom: 15px;"></div>
                        <div style="display: flex; gap: 10px;">
                            <textarea id="chatMessage" placeholder="ì˜ˆ: ë¨¸ë¦¬ê°€ ì•„í”ˆë° ì–´ëŠ ê³¼ë¡œ ê°€ì•¼í• ê¹Œìš”?" style="flex: 1; resize: none; height: 40px;"></textarea>
                            <button class="btn" id="chatStartBtn" onclick="startChat()" style="height: 40px; white-space: nowrap;">ì±„íŒ… ì‹œì‘</button>
                            <button class="btn" id="chatSendBtn" onclick="sendChatMessage()" style="display:none; height: 40px;">ì „ì†¡</button>
                            <button class="btn btn-secondary" id="chatEndBtn" onclick="endChat()" style="display:none; height: 40px;">ì¢…ë£Œ</button>
                        </div>
                    </div>
                    <!-- ì˜ˆì•½ ì •ë³´ ì˜ì—­ -->
                    <div style="flex: 1; border: 2px solid #e9ecef; border-radius: 10px; padding: 15px;">
                        <h4 style="margin-top: 0; color: #4CAF50;">ğŸ“… ì˜ˆì•½ ì •ë³´</h4>
                        <div id="recommendedInfo" style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                            <p><strong>ğŸ’¡ AI ì¶”ì²œ:</strong></p>
                            <div id="aiRecommendation">AIì™€ ëŒ€í™”ë¥¼ ì‹œì‘í•˜ë©´<br>ë§ì¶¤ ì§„ë£Œê³¼ ë° ì‹œê°„ì´<br>ì¶”ì²œë©ë‹ˆë‹¤!</div>
                        </div>
                        
                        <div class="form-group">
                            <label>ì§„ë£Œê³¼</label>
                            <select id="quickDepartment">
                                <option value="">ì§„ë£Œê³¼ ì„ íƒ</option>
                                <option value="ë‚´ê³¼">ë‚´ê³¼</option>
                                <option value="ì™¸ê³¼">ì™¸ê³¼</option>
                                <option value="ì†Œì•„ê³¼">ì†Œì•„ê³¼</option>
                                <option value="ì •í˜•ì™¸ê³¼">ì •í˜•ì™¸ê³¼</option>
                                <option value="í”¼ë¶€ê³¼">í”¼ë¶€ê³¼</option>
                                <option value="ì‹ ê²½ê³¼">ì‹ ê²½ê³¼</option>
                                <option value="ì •ì‹ ê±´ê°•ì˜í•™ê³¼">ì •ì‹ ê±´ê°•ì˜í•™ê³¼</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>ì˜ˆì•½ ë‚ ì§œ</label>
                            <input type="date" id="quickDate" min="" value="">
                        </div>
                        
                        <div class="form-group">
                            <label>ì˜ˆì•½ ì‹œê°„</label>
                            <select id="quickTime">
                                <option value="">ì‹œê°„ ì„ íƒ</option>
                                <option value="10:00">10:00</option>
                                <option value="10:30">10:30</option>
                                <option value="11:00">11:00</option>
                                <option value="11:30">11:30</option>
                                <option value="14:00">14:00</option>
                                <option value="14:30">14:30</option>
                                <option value="15:00">15:00</option>
                                <option value="15:30">15:30</option>
                                <option value="16:00">16:00</option>
                                <option value="16:30">16:30</option>
                            </select>
                        </div>
                        
                        <button class="btn" onclick="makeQuickReservation()" style="width: 100%; margin-top: 10px;">
                            ğŸ¥ ë¹ ë¥¸ ì˜ˆì•½í•˜ê¸°
                        </button>
                        
                        <div id="quickReservationResult" class="response" style="margin-top: 10px;"></div>
                    </div>
                </div>
            </div>

            <!-- ë³‘ì› ê´€ë¦¬ì - ì§„ë£Œê³¼ ê´€ë¦¬ -->
            <div class="test-card">
                <h3>ğŸ¥ ì§„ë£Œê³¼ ê´€ë¦¬ (ê´€ë¦¬ììš©)</h3>
                <div class="form-group">
                    <label>ì§„ë£Œê³¼ëª…</label>
                    <input type="text" id="departmentName" value="ë‚´ê³¼">
                </div>
                <div class="form-group">
                    <label>ì§„ë£Œê³¼ ì„¤ëª…</label>
                    <input type="text" id="departmentDescription" value="ë‚´ê³¼ ì§„ë£Œë¥¼ ë‹´ë‹¹í•©ë‹ˆë‹¤">
                </div>
                <button class="btn" onclick="createDepartment()">ì§„ë£Œê³¼ ìƒì„±</button>
                <button class="btn btn-secondary" onclick="getDepartments()">ì§„ë£Œê³¼ ëª©ë¡</button>
                <div class="response" id="departmentResponse"></div>
            </div>

            <!-- ë³‘ì› ê´€ë¦¬ì - ì‹œê°„ ì°¨ë‹¨ ê´€ë¦¬ -->
            <div class="test-card">
                <h3>â° ì‹œê°„ ì°¨ë‹¨ ê´€ë¦¬ (ê´€ë¦¬ììš©)</h3>
                <div class="form-group">
                    <label>ì§„ë£Œê³¼ ID (Hospital Department ID)</label>
                    <input type="number" id="blockDepartmentId" value="1">
                </div>
                <div class="form-group">
                    <label>ì°¨ë‹¨í•  ë‚ ì§œ</label>
                    <input type="date" id="blockDate">
                </div>
                <div class="form-group">
                    <label>ì°¨ë‹¨í•  ì‹œê°„</label>
                    <select id="blockTime">
                        <option value="10:00">10:00</option>
                        <option value="10:30">10:30</option>
                        <option value="11:00">11:00</option>
                        <option value="11:30">11:30</option>
                        <option value="14:00">14:00</option>
                        <option value="14:30">14:30</option>
                        <option value="15:00">15:00</option>
                        <option value="15:30">15:30</option>
                        <option value="16:00">16:00</option>
                        <option value="16:30">16:30</option>
                    </select>
                </div>
                <button class="btn" onclick="blockTimeSlot()">ì‹œê°„ ì°¨ë‹¨</button>
                <button class="btn btn-secondary" onclick="getBlockedTimeSlots()">ì°¨ë‹¨ ì‹œê°„ ì¡°íšŒ</button>
                <div class="response" id="timeBlockResponse"></div>
            </div>

            <!-- í™˜ì - ì‹œê°„ëŒ€ ì¡°íšŒ -->
            <div class="test-card">
                <h3>ğŸ“… ì˜ˆì•½ ê°€ëŠ¥ ì‹œê°„ ì¡°íšŒ (í™˜ììš©)</h3>
                <div class="form-group">
                    <label>ë³‘ì› ID</label>
                    <input type="number" id="availableHospitalId" value="1">
                </div>
                <div class="form-group">
                    <label>ì§„ë£Œê³¼ëª…</label>
                    <select id="availableDepartment">
                        <option value="">ì§„ë£Œê³¼ ì„ íƒ</option>
                        <option value="ë‚´ê³¼">ë‚´ê³¼</option>
                        <option value="ì™¸ê³¼">ì™¸ê³¼</option>
                        <option value="ì†Œì•„ê³¼">ì†Œì•„ê³¼</option>
                        <option value="ì •í˜•ì™¸ê³¼">ì •í˜•ì™¸ê³¼</option>
                        <option value="í”¼ë¶€ê³¼">í”¼ë¶€ê³¼</option>
                        <option value="ì‹ ê²½ê³¼">ì‹ ê²½ê³¼</option>
                        <option value="ì •ì‹ ê±´ê°•ì˜í•™ê³¼">ì •ì‹ ê±´ê°•ì˜í•™ê³¼</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ì˜ˆì•½ í¬ë§ ë‚ ì§œ</label>
                    <input type="date" id="availableDate">
                </div>
                <button class="btn" onclick="getAvailableTimeSlots()">ì‹œê°„ëŒ€ ì¡°íšŒ</button>
                <div class="response" id="availableTimeSlotsResponse"></div>
            </div>

            <!-- í™˜ì - ì˜ˆì•½ ìƒì„± -->
            <div class="test-card">
                <h3>ğŸ“‹ ì˜ˆì•½ ìƒì„± (í™˜ììš©)</h3>
                <div class="form-group">
                    <label>ë³‘ì› ID</label>
                    <input type="number" id="appointmentHospitalId" value="1">
                </div>
                <div class="form-group">
                    <label>ì§„ë£Œê³¼ëª…</label>
                    <select id="appointmentDepartment">
                        <option value="">ì§„ë£Œê³¼ ì„ íƒ</option>
                        <option value="ë‚´ê³¼">ë‚´ê³¼</option>
                        <option value="ì™¸ê³¼">ì™¸ê³¼</option>
                        <option value="ì†Œì•„ê³¼">ì†Œì•„ê³¼</option>
                        <option value="ì •í˜•ì™¸ê³¼">ì •í˜•ì™¸ê³¼</option>
                        <option value="í”¼ë¶€ê³¼">í”¼ë¶€ê³¼</option>
                        <option value="ì‹ ê²½ê³¼">ì‹ ê²½ê³¼</option>
                        <option value="ì •ì‹ ê±´ê°•ì˜í•™ê³¼">ì •ì‹ ê±´ê°•ì˜í•™ê³¼</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ì˜ˆì•½ ë‚ ì§œ</label>
                    <input type="date" id="appointmentDate">
                </div>
                <div class="form-group">
                    <label>ì˜ˆì•½ ì‹œê°„</label>
                    <select id="appointmentTime">
                        <option value="">ì‹œê°„ ì„ íƒ</option>
                        <option value="10:00">10:00</option>
                        <option value="10:30">10:30</option>
                        <option value="11:00">11:00</option>
                        <option value="11:30">11:30</option>
                        <option value="14:00">14:00</option>
                        <option value="14:30">14:30</option>
                        <option value="15:00">15:00</option>
                        <option value="15:30">15:30</option>
                        <option value="16:00">16:00</option>
                        <option value="16:30">16:30</option>
                    </select>
                </div>
                <button class="btn" onclick="createAppointment()">ì˜ˆì•½í•˜ê¸°</button>
                <div class="response" id="appointmentResponse"></div>
            </div>

            <!-- ì˜ˆì•½ ê´€ë¦¬ -->
            <div class="test-card">
                <h3>ğŸ“ ì˜ˆì•½ ê´€ë¦¬</h3>
                <button class="btn" onclick="getTodayAppointments()">ì˜¤ëŠ˜ ì˜ˆì•½ ì¡°íšŒ</button>
                <button class="btn" onclick="getWaitingPatients()">ëŒ€ê¸° í™˜ì ì¡°íšŒ</button>
                <button class="btn btn-secondary" onclick="getMyAppointments()" title="í˜„ì¬ API ë¯¸êµ¬í˜„">ë‚´ ì˜ˆì•½ ì¡°íšŒ</button>
                
                <div style="margin-top: 15px;">
                    <div class="form-group">
                        <label>ì˜ˆì•½ ID (ì²´í¬ì¸/ìƒíƒœë³€ê²½ìš©)</label>
                        <input type="number" id="appointmentId" value="1">
                    </div>
                    <div class="form-group">
                        <label>ìƒíƒœ ë³€ê²½</label>
                        <select id="appointmentStatus">
                            <option value="WAITING">ëŒ€ê¸°</option>
                            <option value="CHECKED_IN">ì²´í¬ì¸</option>
                            <option value="IN_PROGRESS">ì§„ë£Œì¤‘</option>
                            <option value="COMPLETED">ì™„ë£Œ</option>
                            <option value="CANCELLED">ì·¨ì†Œ</option>
                        </select>
                    </div>
                    <button class="btn" onclick="checkinAppointment()">ì²´í¬ì¸</button>
                    <button class="btn" onclick="updateAppointmentStatus()">ìƒíƒœ ë³€ê²½</button>
                    <button class="btn" onclick="callPatient()">í™˜ì í˜¸ì¶œ</button>
                </div>
                <div class="response" id="appointmentManagementResponse"></div>
            </div>

        </div>
    </div>

    <script>
        const BASE_URL = 'http://localhost:8080';
        let stompClient = null;
        let chatSessionId = null;

        // í† í° ê´€ë¦¬
        function saveToken(token, userType, userInfo) {
            localStorage.setItem('jwt_token', token);
            localStorage.setItem('user_type', userType);
            localStorage.setItem('user_info', JSON.stringify(userInfo));
            updateAuthStatus();
        }
        
        function getToken() {
            return localStorage.getItem('jwt_token');
        }
        
        function clearAuth() {
            localStorage.removeItem('jwt_token');
            localStorage.removeItem('user_type');
            localStorage.removeItem('user_info');
            endChat();
            updateAuthStatus();
        }
        
        function getUserInfo() {
            const userInfo = localStorage.getItem('user_info');
            return userInfo ? JSON.parse(userInfo) : null;
        }
        
        function getUserType() {
            return localStorage.getItem('user_type');
        }
        
        // ì¸ì¦ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateAuthStatus() {
            const token = getToken();
            const userType = getUserType();
            const userInfo = getUserInfo();
            const authStatus = document.getElementById('authStatus');
            const currentUser = document.getElementById('currentUser');
            
            if (token && userType && userInfo) {
                authStatus.className = 'auth-status logged-in';
                authStatus.textContent = 'ë¡œê·¸ì¸ ìƒíƒœ';
                if (userType === 'patient') {
                    currentUser.textContent = `í™˜ì: ${userInfo.name} (ID: ${userInfo.id})`;
                } else if (userType === 'admin') {
                    currentUser.textContent = `ê´€ë¦¬ì: ${userInfo.adminName} (${userInfo.hospitalName})`;
                }
            } else {
                authStatus.className = 'auth-status logged-out';
                authStatus.textContent = 'ë¡œê·¸ì•„ì›ƒ ìƒíƒœ';
                currentUser.textContent = 'ë¡œê·¸ì¸í•˜ì„¸ìš”';
            }
        }
        
        // API í˜¸ì¶œ ê³µí†µ í•¨ìˆ˜
        async function apiCall(endpoint, method = 'GET', data = null, responseId = null, needAuth = false) {
            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    }
                };
                
                if (needAuth) {
                    const token = getToken();
                    if (token) {
                        options.headers['Authorization'] = `Bearer ${token}`;
                    } else {
                         throw new Error("ì¸ì¦ í† í°ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”.");
                    }
                }
                
                if (data) {
                    options.body = JSON.stringify(data);
                }
                
                const response = await fetch(`${BASE_URL}${endpoint}`, options);
                const result = await response.json();
                
                if (responseId) {
                    const responseElement = document.getElementById(responseId);
                    if (response.ok && result.code !== 'SERVER_ERROR' && result.code == null) {
                        responseElement.className = 'response success';
                        responseElement.textContent = `Status: ${response.status}\nResponse: ${JSON.stringify(result, null, 2)}`;
                    } else {
                        responseElement.className = 'response error';
                        responseElement.textContent = `Status: ${response.status}\nError: ${JSON.stringify(result, null, 2)}`;
                    }
                }
                
                return { ok: response.ok, status: response.status, body: result };
                
            } catch (error) {
                if (responseId) {
                    const responseElement = document.getElementById(responseId);
                    responseElement.className = 'response error';
                    responseElement.textContent = `Network Error: ${error.message}`;
                }
                return { ok: false, error: error.message };
            }
        }
        
        // --- ì±—ë´‡ ìŠ¤í¬ë¦½íŠ¸ (ì—…ê·¸ë ˆì´ë“œ) ---
        async function startChat() {
            const userInfo = getUserInfo();
            if (getUserType() !== 'patient') {
                alert('í™˜ì ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }

            const initialMessage = document.getElementById('chatMessage').value;
            if (!initialMessage.trim()) {
                alert('ì²« ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // AI ì¶”ì²œ ì´ˆê¸°í™”
            document.getElementById('aiRecommendation').innerHTML = 'ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤... ğŸ¤”';
            
            // 1. REST APIë¡œ ì±„íŒ… ì„¸ì…˜ ì‹œì‘
            const result = await apiCall('/api/v1/chat/start', 'POST', {
                memberId: userInfo.id,
                initialMessage: initialMessage
            }, null, true);

            if (!result.ok || !result.body.data) {
                alert('ì±„íŒ… ì„¸ì…˜ ì‹œì‘ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + JSON.stringify(result.body));
                document.getElementById('aiRecommendation').innerHTML = 'AIì™€ ëŒ€í™”ë¥¼ ì‹œì‘í•˜ë©´<br>ë§ì¶¤ ì§„ë£Œê³¼ ë° ì‹œê°„ì´<br>ì¶”ì²œë©ë‹ˆë‹¤!';
                return;
            }

            chatSessionId = result.body.data.sessionId;
            
            // UIë¥¼ ì±„íŒ… ëª¨ë“œë¡œ ë³€ê²½
            const chatResponse = document.getElementById('chatResponse');
            chatResponse.innerHTML = ''; // ì±„íŒ…ì°½ ì´ˆê¸°í™”
            chatResponse.className = 'response chat-window'; // ì±„íŒ…ì°½ ìŠ¤íƒ€ì¼ ì ìš©

            document.getElementById('chatStartBtn').style.display = 'none';
            document.getElementById('chatSendBtn').style.display = 'inline-block';
            document.getElementById('chatEndBtn').style.display = 'inline-block';
            document.getElementById('chatMessage').value = '';
            document.getElementById('chatMessage').placeholder = 'ì¶”ê°€ ì¦ìƒì´ë‚˜ ê¶ê¸ˆí•œ ê²ƒì„ ë¬¼ì–´ë³´ì„¸ìš”...';

            // ì²« ë©”ì‹œì§€ë“¤ í‘œì‹œ
            displayChatMessage(initialMessage, 'user');
            const firstAiMessage = result.body.data.messages.find(m => m.senderType === 'AI');
            if (firstAiMessage) {
                displayChatMessage(firstAiMessage.content, 'ai');
            }

            // 2. WebSocket ì—°ê²°
            connectWebSocket();
        }

        function connectWebSocket() {
            // WebSocket ì—°ê²° ì‹œë„í•˜ë˜, ì‹¤íŒ¨í•´ë„ REST API ì‚¬ìš©
            if (stompClient && stompClient.connected) return;

            const token = getToken();
            if (!token) {
                console.warn('WebSocket ì—°ê²°ì„ ìœ„í•œ í† í°ì´ ì—†ìŠµë‹ˆë‹¤. REST APIë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.');
                displayChatMessage('ì±„íŒ… ì¤€ë¹„ ì™„ë£Œ (REST API ëª¨ë“œ)', 'system');
                return;
            }

            try {
                const socket = new SockJS(`${BASE_URL}/ws/chat`);
                stompClient = Stomp.over(socket);

                const headers = {
                    'Authorization': `Bearer ${token}`
                };

                stompClient.connect(headers, function (frame) {
                    console.log('WebSocket Connected: ' + frame);
                    displayChatMessage('ì±„íŒ… ì„œë²„ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤. (WebSocket ëª¨ë“œ)', 'system');
                    
                    stompClient.subscribe('/topic/chat', function (message) {
                        const chatMessage = JSON.parse(message.body);
                        console.log('WebSocket ë©”ì‹œì§€ ìˆ˜ì‹ :', chatMessage);
                        // AI ë©”ì‹œì§€ë§Œ í‘œì‹œ (senderTypeì´ AIì¸ ê²½ìš°)
                        if (chatMessage.senderType === 'AI') {
                            displayChatMessage(chatMessage.content, 'ai');
                            updateAIRecommendation(chatMessage.content);
                        }
                    });

                }, function(error) {
                    console.warn('WebSocket ì—°ê²° ì‹¤íŒ¨, REST APIë¡œ ëŒ€ì²´:', error);
                    stompClient = null;
                    displayChatMessage('ì±„íŒ… ì¤€ë¹„ ì™„ë£Œ (REST API ëª¨ë“œ)', 'system');
                });
            } catch (error) {
                console.warn('WebSocket ì´ˆê¸°í™” ì‹¤íŒ¨, REST APIë¡œ ëŒ€ì²´:', error);
                stompClient = null;
                displayChatMessage('ì±„íŒ… ì¤€ë¹„ ì™„ë£Œ (REST API ëª¨ë“œ)', 'system');
            }
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatMessage');
            const messageContent = input.value.trim();
            const userInfo = getUserInfo();

            if (!messageContent) {
                alert('ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!chatSessionId) {
                alert('ë¨¼ì € ì±„íŒ… ì‹œì‘ì„ í•˜ì„¸ìš”.');
                return;
            }

            // ì‚¬ìš©ì ë©”ì‹œì§€ í‘œì‹œ
            displayChatMessage(messageContent, 'user');
            input.value = '';

            // WebSocketì´ ì—°ê²°ë˜ì–´ ìˆìœ¼ë©´ WebSocket ì‚¬ìš©, ì•„ë‹ˆë©´ REST API ì‚¬ìš©
            if (stompClient && stompClient.connected) {
                // WebSocketìœ¼ë¡œ ì „ì†¡
                const chatMessage = {
                    sessionId: chatSessionId,
                    memberId: userInfo.id,
                    content: messageContent
                };
                stompClient.send("/app/chat.send", {}, JSON.stringify(chatMessage));
            } else {
                // REST APIë¡œ ì „ì†¡
                try {
                    const response = await apiCall('/api/v1/chat/message', 'POST', {
                        sessionId: chatSessionId,
                        memberId: userInfo.id,
                        content: messageContent
                    }, null, true);

                    if (response.ok && response.body.data) {
                        displayChatMessage(response.body.data.content, 'ai');
                        updateAIRecommendation(response.body.data.content);
                    } else {
                        displayChatMessage('AI ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.', 'system-error');
                    }
                } catch (error) {
                    console.error('ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨:', error);
                    displayChatMessage('ë©”ì‹œì§€ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'system-error');
                }
            }
        }

        function endChat() {
            if (stompClient) {
                stompClient.disconnect(() => {
                    console.log('Disconnected');
                });
                stompClient = null;
            }
            chatSessionId = null;

            // UIë¥¼ ì´ˆê¸° ìƒíƒœë¡œ ë³µì›
            const chatResponse = document.getElementById('chatResponse');
            chatResponse.innerHTML = '';
            chatResponse.className = 'response';

            document.getElementById('chatStartBtn').style.display = 'inline-block';
            document.getElementById('chatSendBtn').style.display = 'none';
            document.getElementById('chatEndBtn').style.display = 'none';
            document.getElementById('chatMessageLabel').textContent = 'ë©”ì‹œì§€';
        }

        function displayChatMessage(message, type) {
            const chatWindow = document.getElementById('chatResponse');
            const messageItem = document.createElement('div');
            messageItem.className = 'chat-message-item ' + type;

            const bubble = document.createElement('div');
            bubble.className = 'chat-message-bubble';
            bubble.textContent = message;

            messageItem.appendChild(bubble);
            chatWindow.appendChild(messageItem);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        // AI ì¶”ì²œ ì •ë³´ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateAIRecommendation(message) {
            const recommendation = document.getElementById('aiRecommendation');
            
            // AI ë©”ì‹œì§€ì—ì„œ ì§„ë£Œê³¼ ì¶”ì²œ ì¶”ì¶œ
            const departmentMatches = message.match(/([ê°€-í£]+ê³¼|ë‚´ê³¼|ì™¸ê³¼)/g);
            if (departmentMatches) {
                const suggestedDepartment = departmentMatches[0];
                document.getElementById('quickDepartment').value = suggestedDepartment;
                recommendation.innerHTML = `<strong>ğŸ¥ ì¶”ì²œ ì§„ë£Œê³¼:</strong> ${suggestedDepartment}<br><small>AIê°€ ì¦ìƒì„ ë¶„ì„í•˜ì—¬ ì¶”ì²œí•œ ì§„ë£Œê³¼ì…ë‹ˆë‹¤.</small>`;
                
                // ë‚´ì¼ ë‚ ì§œë¡œ ìë™ ì„¤ì •
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                document.getElementById('quickDate').value = tomorrow.toISOString().split('T')[0];
            }
        }

        // ë¹ ë¥¸ ì˜ˆì•½ í•¨ìˆ˜
        async function makeQuickReservation() {
            const userInfo = getUserInfo();
            if (getUserType() !== 'patient') {
                alert('í™˜ì ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }

            const department = document.getElementById('quickDepartment').value;
            const date = document.getElementById('quickDate').value;
            const time = document.getElementById('quickTime').value;

            if (!department || !date || !time) {
                alert('ì§„ë£Œê³¼, ë‚ ì§œ, ì‹œê°„ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const data = {
                memberId: userInfo.id,
                hospitalId: 1, // êµ¬ë¦„ëŒ€ë³‘ì› ê³ ì •
                departmentName: department,
                appointmentDate: date,
                appointmentTime: time
            };

            const result = await apiCall('/api/v1/appointments', 'POST', data, 'quickReservationResult');
            if (result.ok && result.body.data) {
                document.getElementById('aiRecommendation').innerHTML = `
                    <strong>âœ… ì˜ˆì•½ ì™„ë£Œ!</strong><br>
                    ì˜ˆì•½ ID: ${result.body.data}<br>
                    ë‚ ì§œ: ${date} ${time}<br>
                    ì§„ë£Œê³¼: ${department}
                `;
                
                // ì±„íŒ…ì°½ì— ì˜ˆì•½ ì™„ë£Œ ë©”ì‹œì§€ í‘œì‹œ
                if (chatSessionId) {
                    displayChatMessage(`ì˜ˆì•½ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ì˜ˆì•½ ID: ${result.body.data}`, 'system');
                }
            }
        }

        // ì±„íŒ… ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜ ê°œì„ 
        function displayChatMessage(message, type) {
            const chatWindow = document.getElementById('chatResponse');
            const messageItem = document.createElement('div');
            messageItem.className = 'chat-message-item ' + type;
            
            const bubble = document.createElement('div');
            bubble.className = 'chat-message-bubble';
            bubble.innerHTML = message.replace(/\n/g, '<br>');
            
            messageItem.appendChild(bubble);
            chatWindow.appendChild(messageItem);
            chatWindow.scrollTop = chatWindow.scrollHeight;
            
            // AI ë©”ì‹œì§€ì¸ ê²½ìš° ì¶”ì²œ ì •ë³´ ì—…ë°ì´íŠ¸
            if (type === 'ai') {
                updateAIRecommendation(message);
            }
        }

        // --- ì˜ˆì•½ ê´€ë¦¬ í•¨ìˆ˜ë“¤ ---
        
        // ë³‘ì› ê´€ë¦¬ì - ì§„ë£Œê³¼ ìƒì„±
        async function createDepartment() {
            const userInfo = getUserInfo();
            if (getUserType() !== 'admin') {
                alert('ê´€ë¦¬ì ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }

            const data = {
                name: document.getElementById('departmentName').value,
                description: document.getElementById('departmentDescription').value
            };

            // hospitalIdëŠ” ê´€ë¦¬ìì˜ ë³‘ì› IDë¥¼ ì‚¬ìš© (ì‹¤ì œë¡œëŠ” ë³‘ì› ì •ë³´ì—ì„œ ê°€ì ¸ì™€ì•¼ í•¨)
            const hospitalId = 1; // ì„ì‹œë¡œ 1ë²ˆ ë³‘ì› ì‚¬ìš©
            await apiCall(`/api/v1/admin/hospitals/${hospitalId}/departments`, 'POST', data, 'departmentResponse', true);
        }

        // ë³‘ì› ê´€ë¦¬ì - ì§„ë£Œê³¼ ëª©ë¡ ì¡°íšŒ
        async function getDepartments() {
            const userInfo = getUserInfo();
            if (getUserType() !== 'admin') {
                alert('ê´€ë¦¬ì ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }

            // hospitalIdëŠ” ê´€ë¦¬ìì˜ ë³‘ì› IDë¥¼ ì‚¬ìš© (ì‹¤ì œë¡œëŠ” ë³‘ì› ì •ë³´ì—ì„œ ê°€ì ¸ì™€ì•¼ í•¨)
            const hospitalId = 1; // ì„ì‹œë¡œ 1ë²ˆ ë³‘ì› ì‚¬ìš©
            await apiCall(`/api/v1/admin/hospitals/${hospitalId}/departments`, 'GET', null, 'departmentResponse', true);
        }

        // ë³‘ì› ê´€ë¦¬ì - ì‹œê°„ ì°¨ë‹¨
        async function blockTimeSlot() {
            const userInfo = getUserInfo();
            if (getUserType() !== 'admin') {
                alert('ê´€ë¦¬ì ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }

            const data = {
                departmentId: parseInt(document.getElementById('blockDepartmentId').value),
                blockDate: document.getElementById('blockDate').value,
                blockTime: document.getElementById('blockTime').value
            };

            await apiCall(`/api/v1/admin/time-slots/block`, 'POST', data, 'timeBlockResponse', true);
        }

        // ë³‘ì› ê´€ë¦¬ì - ì°¨ë‹¨ëœ ì‹œê°„ ì¡°íšŒ
        async function getBlockedTimeSlots() {
            const userInfo = getUserInfo();
            if (getUserType() !== 'admin') {
                alert('ê´€ë¦¬ì ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }

            const departmentId = document.getElementById('blockDepartmentId').value;
            
            await apiCall(`/api/v1/admin/time-slots/blocked?departmentId=${departmentId}`, 'GET', null, 'timeBlockResponse', true);
        }

        // í™˜ì - ì˜ˆì•½ ê°€ëŠ¥ ì‹œê°„ ì¡°íšŒ
        async function getAvailableTimeSlots() {
            if (getUserType() !== 'patient') {
                alert('í™˜ì ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }

            const hospitalId = document.getElementById('availableHospitalId').value;
            const department = document.getElementById('availableDepartment').value;
            const date = document.getElementById('availableDate').value;

            if (!department || !date) {
                alert('ì§„ë£Œê³¼ì™€ ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            await apiCall(`/api/v1/patient/time-slots?hospitalId=${hospitalId}&departmentName=${department}&date=${date}`, 'GET', null, 'availableTimeSlotsResponse', true);
        }

        // í™˜ì - ì˜ˆì•½ ìƒì„±
        async function createAppointment() {
            const userInfo = getUserInfo();
            if (getUserType() !== 'patient') {
                alert('í™˜ì ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }

            const data = {
                memberId: userInfo.id,
                hospitalId: parseInt(document.getElementById('appointmentHospitalId').value),
                departmentName: document.getElementById('appointmentDepartment').value,
                appointmentDate: document.getElementById('appointmentDate').value,
                appointmentTime: document.getElementById('appointmentTime').value
            };

            if (!data.departmentName || !data.appointmentDate || !data.appointmentTime) {
                alert('ì§„ë£Œê³¼, ë‚ ì§œ, ì‹œê°„ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            await apiCall('/api/v1/appointments', 'POST', data, 'appointmentResponse', true);
        }

        // ì˜ˆì•½ ê´€ë¦¬ - ì˜¤ëŠ˜ ì˜ˆì•½ ì¡°íšŒ
        async function getTodayAppointments() {
            const userType = getUserType();
            if (!userType) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }

            // ì‹¤ì œ API ê²½ë¡œì— ë§ê²Œ ìˆ˜ì •
            await apiCall('/api/v1/appointments/today', 'GET', null, 'appointmentManagementResponse', true);
        }

        // ì˜ˆì•½ ê´€ë¦¬ - ëŒ€ê¸° í™˜ì ì¡°íšŒ (ê´€ë¦¬ììš©)
        async function getWaitingPatients() {
            if (getUserType() !== 'admin') {
                alert('ê´€ë¦¬ì ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }

            await apiCall('/api/v1/appointments/today/waiting', 'GET', null, 'appointmentManagementResponse', true);
        }

        // ì˜ˆì•½ ê´€ë¦¬ - ë‚´ ì˜ˆì•½ ì¡°íšŒ (í™˜ììš©) - í˜„ì¬ APIê°€ êµ¬í˜„ë˜ì§€ ì•ŠìŒ
        async function getMyAppointments() {
            const userInfo = getUserInfo();
            if (getUserType() !== 'patient') {
                alert('í™˜ì ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }

            // í˜„ì¬ ë‚´ ì˜ˆì•½ ì¡°íšŒ APIê°€ êµ¬í˜„ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. 
            // ì˜¤ëŠ˜ ì˜ˆì•½ ì¡°íšŒë¡œ ëŒ€ì²´í•©ë‹ˆë‹¤.
            document.getElementById('appointmentManagementResponse').className = 'response error';
            document.getElementById('appointmentManagementResponse').textContent = 'ë‚´ ì˜ˆì•½ ì¡°íšŒ APIê°€ ì•„ì§ êµ¬í˜„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì˜¤ëŠ˜ ì˜ˆì•½ ì¡°íšŒë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.';
        }

        // ì˜ˆì•½ ê´€ë¦¬ - ì²´í¬ì¸
        async function checkinAppointment() {
            const appointmentId = document.getElementById('appointmentId').value;
            const userInfo = getUserInfo();
            if (!appointmentId) {
                alert('ì˜ˆì•½ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const data = {
                appointmentId: parseInt(appointmentId),
                memberId: userInfo ? userInfo.id : 1
            };

            await apiCall('/api/v1/appointments/checkin', 'PUT', data, 'appointmentManagementResponse', true);
        }

        // ì˜ˆì•½ ê´€ë¦¬ - ìƒíƒœ ë³€ê²½
        async function updateAppointmentStatus() {
            const appointmentId = document.getElementById('appointmentId').value;
            const status = document.getElementById('appointmentStatus').value;
            
            if (!appointmentId || !status) {
                alert('ì˜ˆì•½ IDì™€ ìƒíƒœë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            await apiCall(`/api/v1/appointments/${appointmentId}/status/${status}`, 'PUT', null, 'appointmentManagementResponse', true);
        }

        // ì˜ˆì•½ ê´€ë¦¬ - í™˜ì í˜¸ì¶œ (ì•Œë¦¼ ê¸°ëŠ¥)
        async function callPatient() {
            const appointmentId = document.getElementById('appointmentId').value;
            if (!appointmentId) {
                alert('ì˜ˆì•½ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const data = {
                appointmentId: parseInt(appointmentId),
                roomNumber: "101í˜¸" // ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
            };

            await apiCall('/api/v1/notifications/call', 'POST', data, 'appointmentManagementResponse', true);
        }

        // --- ë‚˜ë¨¸ì§€ í•¨ìˆ˜ë“¤ ---
        async function patientSignup() {
            const data = {
                name: document.getElementById('patientName').value,
                gender: document.getElementById('patientGender').value,
                birthDate: document.getElementById('patientBirthDate').value,
                phoneNumber: document.getElementById('patientPhone').value,
                password: document.getElementById('patientPassword').value
            };
            await apiCall('/api/v1/auth/patient/sign-up', 'POST', data, 'patientSignupResponse');
        }
        
        async function patientLogin() {
            const data = {
                phoneNumber: document.getElementById('patientLoginPhone').value,
                password: document.getElementById('patientLoginPassword').value
            };
            const result = await apiCall('/api/v1/auth/patient/sign-in', 'POST', data, 'patientLoginResponse');
            
            if (result.ok && result.body && result.body.data && result.body.data.accessToken) {
                const token = result.body.data.accessToken;
                const loginData = result.body.data;
                
                const userInfo = {
                    id: loginData.memberId,
                    name: loginData.memberName,
                    phoneNumber: data.phoneNumber,
                    role: loginData.role
                };
                saveToken(token, 'patient', userInfo);
                
                const responseElement = document.getElementById('patientLoginResponse');
                responseElement.textContent += '\n\nâœ… ë¡œê·¸ì¸ ì„±ê³µ! JWT í† í°ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.';
                responseElement.textContent += `\nì‚¬ìš©ì ID: ${userInfo.id}`;
                responseElement.textContent += `\nì‚¬ìš©ì ì´ë¦„: ${userInfo.name}`;
            }
        }
        
        async function adminSignup() {
            const data = {
                adminName: document.getElementById('adminName').value,
                adminEmail: document.getElementById('adminEmail').value,
                adminPassword: document.getElementById('adminPassword').value,
                hospitalName: document.getElementById('hospitalName').value,
                hospitalAddress: document.getElementById('hospitalAddress').value
            };
            await apiCall('/api/v1/auth/hospital/sign-up', 'POST', data, 'adminSignupResponse');
        }
        
        async function adminLogin() {
            const data = {
                adminEmail: document.getElementById('adminLoginEmail').value,
                adminPassword: document.getElementById('adminLoginPassword').value
            };
            const result = await apiCall('/api/v1/auth/hospital/sign-in', 'POST', data, 'adminLoginResponse');
            
            if (result.ok && result.body && result.body.data && result.body.data.accessToken) {
                const token = result.body.data.accessToken;
                const loginData = result.body.data;
                
                const userInfo = {
                    id: loginData.memberId,
                    adminName: loginData.memberName,
                    hospitalName: "êµ¬ë¦„ëŒ€ë³‘ì›", // ì‹¤ì œë¡œëŠ” ë³‘ì› ì •ë³´ë„ ì‘ë‹µì— í¬í•¨ì‹œì¼œì•¼ í•¨
                    adminEmail: data.adminEmail,
                    role: loginData.role
                };
                saveToken(token, 'admin', userInfo);
                
                const responseElement = document.getElementById('adminLoginResponse');
                responseElement.textContent += '\n\nâœ… ë¡œê·¸ì¸ ì„±ê³µ! JWT í† í°ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.';
                responseElement.textContent += `\nê´€ë¦¬ì ID: ${userInfo.id}`;
                responseElement.textContent += `\nê´€ë¦¬ì ì´ë¦„: ${userInfo.adminName}`;
            }
        }

        function quickPatientSignup() { patientSignup(); }
        function quickPatientLogin() { patientLogin(); }
        function quickAdminSignup() { adminSignup(); }
        function quickAdminLogin() { adminLogin(); }
        
        function logout() {
            clearAuth();
            clearAll();
            alert('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
        
        function clearAll() {
            const responses = document.querySelectorAll('.response');
            responses.forEach(response => {
                response.textContent = '';
                response.className = 'response';
            });
            endChat();
        }
        
        window.onload = function() {
            updateAuthStatus();
            const today = new Date().toISOString().split('T')[0];
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowStr = tomorrow.toISOString().split('T')[0];
            
            // ê¸°ì¡´ ë‚ ì§œ í•„ë“œë“¤ ì´ˆê¸°í™”
            ['blockDate', 'availableDate', 'appointmentDate'].forEach(id => {
                if(document.getElementById(id)) document.getElementById(id).value = today;
            });
            
            // AI ì±—ë´‡ ì˜ˆì•½ ë‚ ì§œ ì´ˆê¸°í™” (ë‚´ì¼ ë‚ ì§œë¡œ)
            if(document.getElementById('quickDate')) {
                document.getElementById('quickDate').value = tomorrowStr;
                document.getElementById('quickDate').min = today; // ì˜¤ëŠ˜ ì´í›„ë§Œ ì„ íƒ ê°€ëŠ¥
            }
        };
    </script>
</body>
</html>